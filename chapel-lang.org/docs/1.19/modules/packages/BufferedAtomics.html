

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>BufferedAtomics &mdash; Chapel Documentation 1.19</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
  

  
    <link rel="top" title="Chapel Documentation 1.19" href="../../index.html"/>
        <link rel="up" title="Package Modules" href="../packages.html"/>
        <link rel="next" title="Buffers" href="Buffers.html"/>
        <link rel="prev" title="C_BLAS" href="BLAS/C_BLAS.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

<a href="../../index.html" class="icon icon-home"> Chapel Documentation

<!-- display version if button won't be rendered -->
<?php if (false) { ?>
<br>1.19
<?php } ?>

</a>

<?php
// Variables given by sphinx
$chplTitle = "1.19";
$pagename = "modules/packages/BufferedAtomics";
include "../..//versionButton.php";
?>


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Compiling and Running Chapel</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../usingchapel/QUICKSTART.html">Quickstart Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usingchapel/index.html">Using Chapel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../platforms/index.html">Platform-Specific Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../technotes/index.html">Technical Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Writing Chapel Programs</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../language/reference.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Hello World Variants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../primers/index.html">Primers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../language/spec.html">Language Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../builtins/index.html">Built-in Types and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../standard.html">Standard Modules</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../packages.html">Package Modules</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="AllLocalesBarriers.html">AllLocalesBarriers</a></li>
<li class="toctree-l2"><a class="reference internal" href="BLAS.html">BLAS</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">BufferedAtomics</a></li>
<li class="toctree-l2"><a class="reference internal" href="Buffers.html">Buffers</a></li>
<li class="toctree-l2"><a class="reference internal" href="Collection.html">Collection</a></li>
<li class="toctree-l2"><a class="reference internal" href="Crypto.html">Crypto</a></li>
<li class="toctree-l2"><a class="reference internal" href="Curl.html">Curl</a></li>
<li class="toctree-l2"><a class="reference internal" href="DistributedBag.html">DistributedBag</a></li>
<li class="toctree-l2"><a class="reference internal" href="DistributedDeque.html">DistributedDeque</a></li>
<li class="toctree-l2"><a class="reference internal" href="DistributedIters.html">DistributedIters</a></li>
<li class="toctree-l2"><a class="reference internal" href="FFTW.html">FFTW</a></li>
<li class="toctree-l2"><a class="reference internal" href="FFTW_MT.html">FFTW_MT</a></li>
<li class="toctree-l2"><a class="reference internal" href="FunctionalOperations.html">FunctionalOperations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Futures.html">Futures</a></li>
<li class="toctree-l2"><a class="reference internal" href="HDF5.html">HDF5</a></li>
<li class="toctree-l2"><a class="reference internal" href="HDFS.html">HDFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="HDFSiterator.html">HDFSiterator</a></li>
<li class="toctree-l2"><a class="reference internal" href="LAPACK.html">LAPACK</a></li>
<li class="toctree-l2"><a class="reference internal" href="LinearAlgebra.html">LinearAlgebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="MPI.html">MPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="NetCDF.html">NetCDF</a></li>
<li class="toctree-l2"><a class="reference internal" href="Norm.html">Norm</a></li>
<li class="toctree-l2"><a class="reference internal" href="RangeChunk.html">RangeChunk</a></li>
<li class="toctree-l2"><a class="reference internal" href="RecordParser.html">RecordParser</a></li>
<li class="toctree-l2"><a class="reference internal" href="ReplicatedVar.html">ReplicatedVar</a></li>
<li class="toctree-l2"><a class="reference internal" href="Search.html">Search</a></li>
<li class="toctree-l2"><a class="reference internal" href="Sort.html">Sort</a></li>
<li class="toctree-l2"><a class="reference internal" href="TOML.html">TOML</a></li>
<li class="toctree-l2"><a class="reference internal" href="UnorderedAtomics.html">UnorderedAtomics</a></li>
<li class="toctree-l2"><a class="reference internal" href="UnorderedCopy.html">UnorderedCopy</a></li>
<li class="toctree-l2"><a class="reference internal" href="VisualDebug.html">VisualDebug</a></li>
<li class="toctree-l2"><a class="reference internal" href="ZMQ.html">ZMQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="../packages.html#index">Index</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../layoutdist.html">Standard Layouts and Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users-guide/index.html">Chapel Users Guide (WIP)</a></li>
</ul>
<p class="caption"><span class="caption-text">Language History</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../language/evolution.html">Chapel Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../language/archivedSpecs.html">Documentation Archives</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Chapel Documentation</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../packages.html">Package Modules</a> &raquo;</li>
      
    <li>BufferedAtomics</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/modules/packages/BufferedAtomics.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <span class="target" id="module-BufferedAtomics"></span><div class="section" id="bufferedatomics">
<h1>BufferedAtomics<a class="headerlink" href="#bufferedatomics" title="Permalink to this headline">¶</a></h1>
<p><strong>Usage</strong></p>
<div class="highlight-chapel"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">BufferedAtomics</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This module has been deprecated - please use <a class="reference internal" href="UnorderedAtomics.html#module-UnorderedAtomics" title="UnorderedAtomics: .. warning::"><code class="xref chpl chpl-mod docutils literal"><span class="pre">UnorderedAtomics</span></code></a> instead.</p>
</div>
<p>This module provides buffered versions of non-fetching atomic operations for
all <code class="docutils literal"><span class="pre">int</span></code>, <code class="docutils literal"><span class="pre">uint</span></code>, and <code class="docutils literal"><span class="pre">real</span></code> types.  Buffered versions of
<a class="reference internal" href="../../builtins/Atomics.html#Atomics.add" title="Atomics.add"><code class="xref chpl chpl-proc docutils literal"><span class="pre">add()</span></code></a>, <a class="reference internal" href="../../builtins/Atomics.html#Atomics.sub" title="Atomics.sub"><code class="xref chpl chpl-proc docutils literal"><span class="pre">sub()</span></code></a>, <a class="reference internal" href="../../builtins/Atomics.html#Atomics.or" title="Atomics.or"><code class="xref chpl chpl-proc docutils literal"><span class="pre">or()</span></code></a>,
<a class="reference internal" href="../../builtins/Atomics.html#Atomics.and" title="Atomics.and"><code class="xref chpl chpl-proc docutils literal"><span class="pre">and()</span></code></a>, and <a class="reference internal" href="../../builtins/Atomics.html#Atomics.xor" title="Atomics.xor"><code class="xref chpl chpl-proc docutils literal"><span class="pre">xor()</span></code></a> are provided. These
variants are internally buffered and the buffers are flushed implicitly when
full or explicitly with <a class="reference internal" href="#BufferedAtomics.flushAtomicBuff" title="BufferedAtomics.flushAtomicBuff"><code class="xref chpl chpl-proc docutils literal"><span class="pre">flushAtomicBuff()</span></code></a>. These buffered operations
can provide a significant speedup for bulk atomic operations that do not
require strict ordering of operations:</p>
<div class="highlight-chapel"><div class="highlight"><pre><span></span><span class="k">use</span> <span class="nx">BufferedAtomics</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">numTasksPerLocale</span> <span class="o">=</span> <span class="nx">here</span><span class="p">.</span><span class="nx">maxTaskPar</span><span class="p">,</span>
      <span class="nx">iters</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>


<span class="kd">var</span> <span class="nx">a</span><span class="p">:</span> <span class="k">atomic</span> <span class="kt">int</span><span class="p">;</span>

<span class="k">coforall</span> <span class="nx">loc</span> <span class="kd">in</span> <span class="nx">Locales</span> <span class="k">do</span> <span class="k">on</span> <span class="nx">loc</span> <span class="k">do</span>
  <span class="k">coforall</span> <span class="mi">1</span><span class="o">..</span><span class="nx">numTasksPerLocale</span> <span class="k">do</span>
    <span class="k">for</span> <span class="nx">i</span> <span class="kd">in</span> <span class="mi">1</span><span class="o">..</span><span class="nx">iters</span> <span class="k">do</span>
      <span class="nx">a</span><span class="p">.</span><span class="nx">addBuff</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>                   <span class="c1">// buffered atomic add</span>

<span class="nx">flushAtomicBuff</span><span class="p">();</span>                    <span class="c1">// flush any pending operations (required)</span>


<span class="kd">const</span> <span class="nx">itersSum</span> <span class="o">=</span> <span class="nx">iters</span><span class="o">*</span><span class="p">(</span><span class="nx">iters</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span>   <span class="c1">// sum from 1..iters</span>
      <span class="nx">numTasks</span> <span class="o">=</span> <span class="nx">numLocales</span> <span class="o">*</span> <span class="nx">numTasksPerLocale</span><span class="p">;</span>
<span class="nx">assert</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">read</span><span class="p">()</span> <span class="o">==</span> <span class="nx">numTasks</span> <span class="o">*</span> <span class="nx">itersSum</span><span class="p">);</span>
</pre></div>
</div>
<p>It's important to be aware that buffered atomic operations are not
consistent with regular atomic operations and updates may not be visible
until the buffers are explicitly flushed with <a class="reference internal" href="#BufferedAtomics.flushAtomicBuff" title="BufferedAtomics.flushAtomicBuff"><code class="xref chpl chpl-proc docutils literal"><span class="pre">flushAtomicBuff()</span></code></a>.</p>
<div class="highlight-chapel"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">a</span><span class="p">:</span> <span class="k">atomic</span> <span class="kt">int</span><span class="p">;</span>
<span class="nx">a</span><span class="p">.</span><span class="nx">addBuff</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="nx">writeln</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>        <span class="c1">// can print 0 or 1</span>
<span class="nx">flushAtomicBuff</span><span class="p">();</span>
<span class="nx">writeln</span><span class="p">(</span><span class="nx">a</span><span class="p">);</span>        <span class="c1">// prints 1</span>
</pre></div>
</div>
<p>Generally speaking they are useful for when you have a large batch of atomic
updates to perform and the order of those operations doesn't matter.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Currently, these are only optimized for <code class="docutils literal"><span class="pre">CHPL_NETWORK_ATOMICS=ugni</span></code>.
Processor atomics or any other implementation falls back to non-buffered
operations. Under ugni these operations are internally buffered. When the
buffers are flushed, the operations are performed all at once. Cray Linux
Environment (CLE) 5.2.UP04 or newer is required for best performance. In
our experience, buffered atomics can achieve up to a 5X performance
improvement over non-buffered atomics for CLE 5.2UP04 or newer.</p>
</div>
<dl class="method">
<dt id="BufferedAtomics.AtomicT.addBuff">
<em class="property">proc </em><code class="descclassname">AtomicT.</code><code class="descname">addBuff</code><span class="sig-paren">(</span><em>value: T</em><span class="sig-paren">)</span>: void<a class="headerlink" href="#BufferedAtomics.AtomicT.addBuff" title="Permalink to this definition">¶</a></dt>
<dd><p>Buffered atomic add.</p>
</dd></dl>

<dl class="method">
<dt id="BufferedAtomics.AtomicT.subBuff">
<em class="property">proc </em><code class="descclassname">AtomicT.</code><code class="descname">subBuff</code><span class="sig-paren">(</span><em>value: T</em><span class="sig-paren">)</span>: void<a class="headerlink" href="#BufferedAtomics.AtomicT.subBuff" title="Permalink to this definition">¶</a></dt>
<dd><p>Buffered atomic sub.</p>
</dd></dl>

<dl class="method">
<dt id="BufferedAtomics.AtomicT.orBuff">
<em class="property">proc </em><code class="descclassname">AtomicT.</code><code class="descname">orBuff</code><span class="sig-paren">(</span><em>value: T</em><span class="sig-paren">)</span>: void<a class="headerlink" href="#BufferedAtomics.AtomicT.orBuff" title="Permalink to this definition">¶</a></dt>
<dd><p>Buffered atomic or.</p>
</dd></dl>

<dl class="method">
<dt id="BufferedAtomics.AtomicT.andBuff">
<em class="property">proc </em><code class="descclassname">AtomicT.</code><code class="descname">andBuff</code><span class="sig-paren">(</span><em>value: T</em><span class="sig-paren">)</span>: void<a class="headerlink" href="#BufferedAtomics.AtomicT.andBuff" title="Permalink to this definition">¶</a></dt>
<dd><p>Buffered atomic and.</p>
</dd></dl>

<dl class="method">
<dt id="BufferedAtomics.AtomicT.xorBuff">
<em class="property">proc </em><code class="descclassname">AtomicT.</code><code class="descname">xorBuff</code><span class="sig-paren">(</span><em>value: T</em><span class="sig-paren">)</span>: void<a class="headerlink" href="#BufferedAtomics.AtomicT.xorBuff" title="Permalink to this definition">¶</a></dt>
<dd><p>Buffered atomic xor.</p>
</dd></dl>

<dl class="function">
<dt id="BufferedAtomics.flushAtomicBuff">
<em class="property">proc </em><code class="descname">flushAtomicBuff</code><span class="sig-paren">(</span><span class="sig-paren">)</span>: void<a class="headerlink" href="#BufferedAtomics.flushAtomicBuff" title="Permalink to this definition">¶</a></dt>
<dd><p>Flush any atomic operations that are still buffered. Note that this
flushes any pending operations on all locales, not just the current
locale.</p>
</dd></dl>

</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Buffers.html" class="btn btn-neutral float-right" title="Buffers" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="BLAS/C_BLAS.html" class="btn btn-neutral" title="C_BLAS" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Cray Inc.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.19.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 



</body>
</html>