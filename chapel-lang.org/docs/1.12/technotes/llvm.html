

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>LLVM Support &mdash; Chapel Documentation 1.12 1.12.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  

  
    <link rel="top" title="Chapel Documentation 1.12 1.12.0 documentation" href="../index.html"/>
        <link rel="up" title="Technical Notes" href="index.html"/>
        <link rel="next" title="The ‘local’ Statement" href="local.html"/>
        <link rel="prev" title="Exporting Chapel as a Library" href="libraries.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> Chapel Documentation</a>
        
        
<?php   // Variables given by sphinx 
   $chplTitle = "1.12";   $pagename = "./technotes/llvm";   include "../versionButton.php";   ?>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/README.html">Quickstart Instructions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/README.html#quick-start-instructions">Quick Start Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/README.html#what-s-next">What&#8217;s next?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/index.html">Using Chapel</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/prereqs.html">Chapel Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/chplenv.html">Setting up Your Environment for Chapel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/building.html">Building Chapel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/compiling.html">Compiling Chapel Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/executing.html">Executing Chapel Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/multilocale.html">Multilocale Chapel Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/launcher.html">Chapel Launchers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/tasks.html">Chapel Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/debugging.html">Debugging Chapel Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/bugs.html">Reporting Chapel Bugs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/index.html">Platform-Specific Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../platforms/cray.html">Using Chapel on Cray Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/cygwin.html">Using Chapel on Cygwin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/ibm.html">Using Chapel on IBM Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/knc.html">Using Chapel on Intel Xeon Phi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/macosx.html">Using Chapel on Mac OS X</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/marenostrum.html">Using Chapel on MareNostrum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/sgi.html">Using Chapel on SGI Altix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/builtins.html">Built-in Types and Functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/Atomics.html">Atomics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelArray.html">Domain and Array Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelComplex_forDocs.html">Complex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelIO.html">IO Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelIteratorSupport.html">Vectorizing Iterator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelLocale.html">Locales</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelRange.html">Ranges</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelSyncvar.html">Synchronization Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelTuple.html">Tuples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/UtilMisc_forDocs.html">Misc Functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/standardlibrary.html">Standard Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/modules.html">Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/distributions.html">Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/layouts.html">Layouts</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Technical Notes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="allocators.html">Chapel&#8217;s Use of Allocators</a></li>
<li class="toctree-l2"><a class="reference internal" href="atomics.html">Runtime Support for Atomics</a></li>
<li class="toctree-l2"><a class="reference internal" href="auxIO.html">Auxiliary I/O Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="chpl-ipe.html">Interactive Chapel</a></li>
<li class="toctree-l2"><a class="reference internal" href="chpldoc.html">Documenting Chapel</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsi.html">Domain Map Standard Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="extern.html">C Interoperability</a></li>
<li class="toctree-l2"><a class="reference internal" href="firstClassFns.html">First-class Functions in Chapel</a></li>
<li class="toctree-l2"><a class="reference internal" href="libraries.html">Exporting Chapel as a Library</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">LLVM Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="local.html">The &#8216;local&#8217; Statement</a></li>
<li class="toctree-l2"><a class="reference internal" href="localeModels.html">Locale Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="main.html">Support for main() Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="module_search.html">Module Search Paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="reduceIntents.html">Reduce Intents</a></li>
<li class="toctree-l2"><a class="reference internal" href="sets.html">Associative Set Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="subquery.html">Querying a Local Subdomain</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/chplvis/index.html">chplvis</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Chapel Documentation 1.12</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Technical Notes</a> &raquo;</li>
      
    <li>LLVM Support</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/technotes/llvm.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="llvm-support">
<span id="readme-llvm"></span><h1>LLVM Support<a class="headerlink" href="#llvm-support" title="Permalink to this headline">¶</a></h1>
<p>The Chapel compiler can be built with LLVM support in able to enable
the following features:</p>
<blockquote>
<div><ol class="arabic simple">
<li>extern block support (see <a class="reference internal" href="extern.html#readme-extern"><em>C Interoperability</em></a>). This feature uses the clang
parser. Note that it is <em>not</em> necessary to use the LLVM code generator in
order to use extern block support.</li>
<li>Experimental LLVM code generator. The <tt class="docutils literal"><span class="pre">--llvm</span></tt> flag activates the LLVM
code generator. Note that by default, a Chapel compiler built with LLVM
support still uses the C backend.</li>
<li>Experimental LLVM communication optimizations. You can activate these
communication optimizations with <tt class="docutils literal"><span class="pre">--llvm</span> <span class="pre">--llvm-wide-opt</span></tt>. Some
benchmark programs run faster with these LLVM communication optimizations.</li>
</ol>
</div></blockquote>
<div class="section" id="building-the-llvm-support">
<h2>Building the LLVM support<a class="headerlink" href="#building-the-llvm-support" title="Permalink to this headline">¶</a></h2>
<p>To build the compiler with LLVM support for extern blocks, <tt class="docutils literal"><span class="pre">--llvm</span></tt> code
generation, but no support for <tt class="docutils literal"><span class="pre">--llvm-wide-opt</span></tt>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="nb">source</span> ./util/setchplenv.bash
<span class="nb">export </span><span class="nv">CHPL_LLVM</span><span class="o">=</span>llvm

make <span class="c"># you might want to do e.g. make -j 16 for a parallel build</span>
</pre></div>
</div>
<p>To build the compiler with LLVM support for extern blocks, <tt class="docutils literal"><span class="pre">--llvm</span> <span class="pre">code</span></tt>
generation, and also support <tt class="docutils literal"><span class="pre">--llvm-wide-opt</span></tt>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="nb">source</span> ./util/setchplenv.bash
<span class="nb">export </span><span class="nv">CHPL_LLVM</span><span class="o">=</span>llvm
<span class="nb">export </span><span class="nv">CHPL_WIDE_POINTERS</span><span class="o">=</span>node16 <span class="c"># optional but useful with --llvm-wide-opt</span>
                                 <span class="c"># see discussion below</span>

make <span class="c"># you might want to do e.g. make -j 16 for a parallel build</span>
</pre></div>
</div>
<p>Note:</p>
<ul class="simple">
<li>If you have a built llvm in <tt class="docutils literal"><span class="pre">third-party/llvm/install</span></tt>, even if you forget
to <tt class="docutils literal"><span class="pre">export</span> <span class="pre">CHPL_LLVM=llvm</span></tt>, the default will be to use the built llvm.  You
can override this default by setting <tt class="docutils literal"><span class="pre">CHPL_LLVM=none</span></tt>.</li>
<li>the Makefile in third-party/llvm will unpack LLVM and Clang source releases
and build them</li>
<li>LLVM code generation has not been tested on all supported configurations,
and some features (such as building a library instead of an executable)
are not yet supported.</li>
<li>You can set the environment variable <tt class="docutils literal"><span class="pre">CHPL_LLVM_DEVELOPER</span></tt>
to request a debug build of LLVM.</li>
</ul>
</div>
<div class="section" id="activating-the-llvm-support">
<h2>Activating the LLVM support<a class="headerlink" href="#activating-the-llvm-support" title="Permalink to this headline">¶</a></h2>
<p>To compile a program using the LLVM backend, add <tt class="docutils literal"><span class="pre">--llvm</span></tt> to the chpl command
line.</p>
<p>If you pass a <tt class="docutils literal"><span class="pre">--savec</span></tt> directory, the LLVM backend will emit two .bc files
in that directory:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">chpl__module.bc</span></tt> is the version that will be linked</li>
<li><tt class="docutils literal"><span class="pre">chpl__module-nopt.bc</span></tt> is the generated code without optimizations applied.</li>
</ul>
<p>Passing <tt class="docutils literal"><span class="pre">--fast</span></tt> will cause LLVM optimizations to run.</p>
<p>The <tt class="docutils literal"><span class="pre">--ccflags</span></tt> option can control which LLVM optimizations are run, using the
same syntax as flags to clang.</p>
<p>Additionally, if you build your compiler with <tt class="docutils literal"><span class="pre">CHPL_WIDE_POINTERS=node16</span></tt> and
then compile a program with <tt class="docutils literal"><span class="pre">--llvm</span> <span class="pre">--llvm-wide-opt</span> <span class="pre">--fast</span></tt>, you will allow
LLVM optimizations to work with global memory. For example, the Loop Invariant
Code Motion (LICM) optimization might be able to hoist an access of a remote
variable - ie, a &#8216;get&#8217; - out of a loop.  This optimization has produced better
performance with some benchmarks.</p>
<p>CHPL_WIDE_POINTERS=node16 is necessary to use <tt class="docutils literal"><span class="pre">--llvm-wide-opt</span></tt> because of
historical limitations in LLVM support for pointers in different address spaces
having different sizes.  The default <tt class="docutils literal"><span class="pre">CHPL_WIDE_POINTERS=struct</span></tt> uses a
128-bit wide pointer, but <tt class="docutils literal"><span class="pre">CHPL_WIDE_POINTERS=node16</span></tt> packs wide pointers
into a pointer-sized value (normally 64 bits) which includes 16 bits of node
number in order to avoid these problems.  We plan to remove this requirement in
the future to enable <tt class="docutils literal"><span class="pre">--llvm-wide-opt</span></tt> to work with
<tt class="docutils literal"><span class="pre">CHPL_WIDE_POINTERS=struct</span></tt>.</p>
<p>Caveats:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">--llvm-wide-opt</span></tt> currently requires <tt class="docutils literal"><span class="pre">CHPL_WIDE_POINTERS=node16</span></tt>, which
means that it will not work with the numa locale model since packed pointers
will not have a sublocale.</li>
<li><tt class="docutils literal"><span class="pre">--llvm-wide-opt</span></tt> may add communication to or from a task&#8217;s stack, so it
may not function correctly for combinations of tasking and communication
layers in which some task has a stack outside of an acceptable region for
communication (e.g. operations on the initial &#8216;main&#8217; thread may fail with
<tt class="docutils literal"><span class="pre">CHPL_COMM=gasnet</span></tt>, <tt class="docutils literal"><span class="pre">CHPL_GASNET_SEGMENT=fast</span></tt>).</li>
</ul>
</div>
<div class="section" id="how-llvm-wide-opt-works">
<h2>How <tt class="docutils literal"><span class="pre">--llvm-wide-opt</span> <span class="pre">works</span></tt><a class="headerlink" href="#how-llvm-wide-opt-works" title="Permalink to this headline">¶</a></h2>
<p>Communication optimization within LLVM uses the address space feature of LLVM
in order to create a conceptual global address space. In particular, instead of
generating a call to the runtime functions to &#8216;put&#8217; or &#8216;get&#8217;, when
<tt class="docutils literal"><span class="pre">--llvm-wide-opt</span></tt> is enabled, the Chapel compiler will generate a load,
store, or memcpy using an address space 100 pointer. Address space 100 pointers
represent global memory - and address space 0 pointers continue to represent
local memory. The existing LLVM optimization passes will operate normally on
these address space 100 operations. The LLVM documentation describes these
optimizations and which are normally run.</p>
<p>Because it may be necessary to build a global pointer or to gather information
from it - for example when constructing a global pointer from a node number and
a local address, or extracting the node number or the address - the LLVM code
generated with <tt class="docutils literal"><span class="pre">--llvm-wide-opt</span></tt> includes calls to nonexistent functions to
mark these operations:</p>
<ul class="simple">
<li>.gf.addr extracts an address from a global pointer</li>
<li>.gf.loc extracts a locale from a global pointer</li>
<li>.gf.node extracts a node number from a global pointer</li>
<li>.gf.make constructs a global pointer from a locale and an address</li>
<li>.gf.g2w converts a global pointer to a wide pointer</li>
<li>.gf.w2g converts a wide pointer to a global pointer</li>
</ul>
<p>These functions will be replaced with the usual runtime functions once all
global pointers are lowered into wide pointers by the global-to-wide pass.</p>
<p>After the usual LLVM optimization passes run, two Chapel LLVM passes run:</p>
<ul class="simple">
<li>aggregate-global-ops bundles together sequences of loads or sequences of
stores on adjacent global memory locations into a single memcpy. That way,
adjacent loads will generate a single &#8216;get&#8217; instead of several &#8216;get&#8217; calls.</li>
<li>global-to-wide converts operations on address space 100 pointers, notably
including load, store, memcpy, and memset operations, into calls to the
Chapel runtime. It converts address space 100 pointers into packed pointers
and any of the special function calls (e.g. .gf.addr to extract the local
address portion of a global pointer) into the usual operations on a packed
pointer. In the future, we would like to support converting address space 100
pointers into the usual Chapel wide pointer format.</li>
</ul>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="local.html" class="btn btn-neutral float-right" title="The ‘local’ Statement">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="libraries.html" class="btn btn-neutral" title="Exporting Chapel as a Library"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Cray Inc.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.12.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 

</body>
</html>
