

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Exporting Chapel as a Library &mdash; Chapel Documentation 1.12 1.12.0 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  

  
    <link rel="top" title="Chapel Documentation 1.12 1.12.0 documentation" href="../index.html"/>
        <link rel="up" title="Technical Notes" href="index.html"/>
        <link rel="next" title="LLVM Support" href="llvm.html"/>
        <link rel="prev" title="First-class Functions in Chapel" href="firstClassFns.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../index.html" class="fa fa-home"> Chapel Documentation</a>
        
        
<?php   // Variables given by sphinx 
   $chplTitle = "1.12";   $pagename = "./technotes/libraries";   include "../versionButton.php";   ?>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/README.html">Quickstart Instructions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/README.html#quick-start-instructions">Quick Start Instructions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/README.html#what-s-next">What&#8217;s next?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/index.html">Using Chapel</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/prereqs.html">Chapel Prerequisites</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/chplenv.html">Setting up Your Environment for Chapel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/building.html">Building Chapel</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/compiling.html">Compiling Chapel Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/executing.html">Executing Chapel Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/multilocale.html">Multilocale Chapel Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/launcher.html">Chapel Launchers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/tasks.html">Chapel Tasks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/debugging.html">Debugging Chapel Programs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../usingchapel/bugs.html">Reporting Chapel Bugs</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../platforms/index.html">Platform-Specific Notes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../platforms/cray.html">Using Chapel on Cray Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/cygwin.html">Using Chapel on Cygwin</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/ibm.html">Using Chapel on IBM Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/knc.html">Using Chapel on Intel Xeon Phi</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/macosx.html">Using Chapel on Mac OS X</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/marenostrum.html">Using Chapel on MareNostrum</a></li>
<li class="toctree-l2"><a class="reference internal" href="../platforms/sgi.html">Using Chapel on SGI Altix</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/builtins.html">Built-in Types and Functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/Atomics.html">Atomics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelArray.html">Domain and Array Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelComplex_forDocs.html">Complex</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelIO.html">IO Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelIteratorSupport.html">Vectorizing Iterator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelLocale.html">Locales</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelRange.html">Ranges</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelSyncvar.html">Synchronization Variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/ChapelTuple.html">Tuples</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/internal/UtilMisc_forDocs.html">Misc Functions</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../modules/standardlibrary.html">Standard Library</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../modules/modules.html">Modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/distributions.html">Distributions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../modules/layouts.html">Layouts</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Technical Notes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="allocators.html">Chapel&#8217;s Use of Allocators</a></li>
<li class="toctree-l2"><a class="reference internal" href="atomics.html">Runtime Support for Atomics</a></li>
<li class="toctree-l2"><a class="reference internal" href="auxIO.html">Auxiliary I/O Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="chpl-ipe.html">Interactive Chapel</a></li>
<li class="toctree-l2"><a class="reference internal" href="chpldoc.html">Documenting Chapel</a></li>
<li class="toctree-l2"><a class="reference internal" href="dsi.html">Domain Map Standard Interface</a></li>
<li class="toctree-l2"><a class="reference internal" href="extern.html">C Interoperability</a></li>
<li class="toctree-l2"><a class="reference internal" href="firstClassFns.html">First-class Functions in Chapel</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="">Exporting Chapel as a Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="llvm.html">LLVM Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="local.html">The &#8216;local&#8217; Statement</a></li>
<li class="toctree-l2"><a class="reference internal" href="localeModels.html">Locale Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="main.html">Support for main() Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="module_search.html">Module Search Paths</a></li>
<li class="toctree-l2"><a class="reference internal" href="reduceIntents.html">Reduce Intents</a></li>
<li class="toctree-l2"><a class="reference internal" href="sets.html">Associative Set Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="subquery.html">Querying a Local Subdomain</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../tools/chplvis/index.html">chplvis</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Chapel Documentation 1.12</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Technical Notes</a> &raquo;</li>
      
    <li>Exporting Chapel as a Library</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../_sources/technotes/libraries.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="exporting-chapel-as-a-library">
<span id="readme-libraries"></span><h1>Exporting Chapel as a Library<a class="headerlink" href="#exporting-chapel-as-a-library" title="Permalink to this headline">Â¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This page discusses the implementation of libraries, which are still
under development.  The idea is to allow components to be developed in
Chapel and linked with other programs and languages.  It is currently fragile
and difficult to work with.</p>
</div>
<p>Normally, Chapel assumes that you are building a main program and produces a
main routine whether one is explicitly coded or not.  When the <tt class="docutils literal"><span class="pre">--library</span></tt>
flag is provided on the command line, it tells the Chapel compiler to produce a
library instead.  The user can further specify (through the <tt class="docutils literal"><span class="pre">--static</span></tt>
and <tt class="docutils literal"><span class="pre">--dynamic</span></tt> flags) which type of library to produce.  If
neither <tt class="docutils literal"><span class="pre">--static</span></tt> nor <tt class="docutils literal"><span class="pre">--dynamic</span></tt> is specified, a platform-dependent
default library type is produced.</p>
<p>Some platforms support linking against both static and dynamic versions of
the same library.  On those platforms, the <tt class="docutils literal"><span class="pre">--static</span></tt> or <tt class="docutils literal"><span class="pre">--dynamic</span></tt>
flag can be used to select which type of library (and thus which kind of
linking) is performed by default.  Library files which are named explicitly on
the <tt class="docutils literal"><span class="pre">chpl</span></tt> command line take precedence over any found through object
library paths (<tt class="docutils literal"><span class="pre">-L</span></tt>).  Where there is a conflict, the last library
specified takes precedence.</p>
<p>When creating a library file from Chapel code, only those symbols with
<tt class="docutils literal"><span class="pre">export</span></tt> attached to them will be available from outside the library.  For
example, if one defines a Chapel file <tt class="docutils literal"><span class="pre">foo.chpl</span></tt> like this:</p>
<div class="highlight-Chapel"><div class="highlight"><pre><span class="c1">// This function will be available to the library user</span>
<span class="k">export</span> <span class="k">proc</span> <span class="nf">bar</span><span class="p">():</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="c1">// Does something</span>
  <span class="o">..</span><span class="p">.</span>
<span class="p">}</span>

<span class="c1">// As will this one</span>
<span class="k">export</span> <span class="k">proc</span> <span class="nf">baz</span><span class="p">(</span><span class="kt">int</span> <span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Does something different</span>
  <span class="o">..</span><span class="p">.</span>
<span class="p">}</span>

<span class="c1">// but this function will not be</span>
<span class="k">proc</span> <span class="nf">gloop</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Does something else</span>
  <span class="o">..</span><span class="p">.</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When using a Chapel library file in C code, a fairly exact incantation is
required.  First, a header file must be created for the library.  This does not
happen through use of the Chapel <tt class="docutils literal"><span class="pre">--library</span></tt> flag during compilation!  If
during compilation of the library the <tt class="docutils literal"><span class="pre">--savec</span> <span class="pre">&lt;dir&gt;</span></tt> flag is also used, the C
definitions for the exported functions should be visible in a C file under
<em>dir</em> of the same name as the library Chapel file.  A declaration version of
these definitions should go into a <tt class="docutils literal"><span class="pre">.h</span></tt> file.  For instance, if one compiled
<tt class="docutils literal"><span class="pre">foo.chpl</span></tt> like this:</p>
<div class="highlight-sh"><div class="highlight"><pre>chpl --library --savec cDir --static -o libfoo foo.chpl
</pre></div>
</div>
<p>then under <tt class="docutils literal"><span class="pre">cDir/foo.c</span></tt> one might see something resembling:</p>
<div class="highlight-C"><div class="highlight"><pre><span class="kt">int64_t</span> <span class="nf">bar</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">baz</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>from which one would create a <tt class="docutils literal"><span class="pre">.h</span></tt> file:</p>
<div class="highlight-C"><div class="highlight"><pre><span class="kt">int64_t</span> <span class="nf">bar</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">baz</span><span class="p">(</span><span class="kt">int64_t</span> <span class="n">x</span><span class="p">);</span>
</pre></div>
</div>
<p>It may be necessary to <tt class="docutils literal"><span class="pre">#include</span></tt> some Chapel headers, such as
<tt class="docutils literal"><span class="pre">chpl-string.h</span></tt>, depending on the types used in your Chapel library.</p>
<p>Next, if compiling dynamically, update the <tt class="docutils literal"><span class="pre">$LD_LIBRARY_PATH</span></tt> environment
variable to include the directory where the new library file lives and the
directory where the Chapel build lives.  The latter can be found by looking at
the output of a <tt class="docutils literal"><span class="pre">$CHPL_HOME/util/printchplenv</span></tt> call and finding the
appropriate directory under <tt class="docutils literal"><span class="pre">$CHPL_HOME/lib</span></tt>; the directory name can be found
by running <tt class="docutils literal"><span class="pre">$CHPL_HOME/util/printchplenv</span> <span class="pre">--runtime</span></tt>.</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c"># Replace $PWD with the appropriate path to your library file if it isn&#39;t</span>
<span class="c"># in the current directory</span>
<span class="c"># Replace libDir with the directory we just found.</span>
<span class="nb">export </span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="nv">$PWD</span>:<span class="nv">$CHPL_HOME</span>/lib/<span class="sb">`</span><span class="nv">$CHPL_HOME</span>/util/printchplenv --runtime<span class="sb">`</span>:<span class="nv">$LD_LIBRARY_PATH</span>
</pre></div>
</div>
<p>When using a Chapel library from C, one must first initialize the Chapel runtime
and standard modules.  This is done by the addition of a couple of extern
declarations, calling the function <tt class="docutils literal"><span class="pre">chpl_library_init()</span></tt> before the Chapel
library function calls and by calling <tt class="docutils literal"><span class="pre">chpl_library_finalize()</span></tt> after all the
Chapel library function calls are finished.  For example:</p>
<div class="highlight-C"><div class="highlight"><pre><span class="cp">#include &quot;foo.h&quot;</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="nf">chpl_library_init</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="nf">chpl_library_finalize</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="n">chpl_library_init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>

    <span class="n">baz</span><span class="p">(</span><span class="mi">7</span><span class="p">);</span> <span class="c1">// Call into a library function</span>

    <span class="n">chpl_library_finalize</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Finally, compilation of the C program involves some additional command line
includes and links.  The easiest way to get the right combination is by using
the <tt class="docutils literal"><span class="pre">compileline</span> <span class="pre">--compile</span></tt> and <tt class="docutils literal"><span class="pre">compileline</span> <span class="pre">--libraries</span></tt> tools we provide.
The compilation command would then look like this (replacing myprog.c with the
name of your C program):</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="sb">`</span><span class="nv">$CHPL_HOME</span>/util/config/compileline --compile<span class="sb">`</span> myprog.c -L. -lfoo <span class="sb">`</span><span class="nv">$CHPL_HOME</span>/util/config/compileline --libraries<span class="sb">`</span>
</pre></div>
</div>
<p>Chapel library files cannot be used from Chapel code.  The library files must
include the chapel runtime and standard modules for use in a non-Chapel program
and when the library is linked to a Chapel program this leads to multiple
definitions of these functions.</p>
<p>As mentioned above, this feature is not very sturdy.  Please refer to
<a class="reference internal" href="../usingchapel/bugs.html#readme-bugs"><em>Reporting Chapel Bugs</em></a> if any problems are encountered.</p>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="llvm.html" class="btn btn-neutral float-right" title="LLVM Support">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="firstClassFns.html" class="btn btn-neutral" title="First-class Functions in Chapel"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Cray Inc.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.12.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 

</body>
</html>
