<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>chplcheck &mdash; Chapel Documentation 2.3</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/style.css?v=70f659a1" />

  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=c3c8ae58"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="chplvis" href="../chplvis/chplvis.html" />
    <link rel="prev" title="chpl-language-server" href="../chpl-language-server/chpl-language-server.html" />
   
  

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

<a href="../../index.html" class="icon icon-home"> Chapel Documentation

<!-- display version if button won't be rendered -->
<?php if (false) { ?>
<br>2.3
<?php } ?>

</a>

<?php
// Variables given by sphinx
$chplTitle = "2.3";
$pagename = "tools/chplcheck/chplcheck";
include "../..//versionButton.php";
?>


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>


        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
  
              <p class="caption" role="heading"><span class="caption-text">Compiling and Running Chapel</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../usingchapel/QUICKSTART.html">Quickstart Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usingchapel/index.html">Using Chapel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../platforms/index.html">Platform-Specific Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../technotes/index.html">Technical Notes</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tools</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#documentation">Documentation</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#development">Development</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../chpl-language-server/chpl-language-server.html">chpl-language-server</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">chplcheck</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#getting-started">Getting Started</a></li>
<li class="toctree-l4"><a class="reference internal" href="#enabling-disabling-rules">Enabling / Disabling Rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#fixits">Fixits</a></li>
<li class="toctree-l4"><a class="reference internal" href="#setting-up-in-your-editor">Setting Up In Your Editor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#writing-new-rules">Writing New Rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-custom-rules">Adding Custom Rules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../chplvis/chplvis.html">chplvis</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mason/mason.html">Mason</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#interoperability">Interoperability</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#other">Other</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/index.html">Docs for Contributors</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Writing Chapel Programs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../language/reference.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">Hello World Variants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../primers/index.html">Primers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../language/spec/index.html">Language Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/standard.html">Standard Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/packages.html">Package Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules/layoutdist.html">Standard Layouts and Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mason-packages/index.html">Mason Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../users-guide/index.html">Chapel Users Guide (WIP)</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Language History</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../language/evolution.html">Chapel Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../language/archivedSpecs.html">Documentation Archives</a></li>
</ul>

  <p class="caption" role="heading"><span class="caption-text">Indexes</span></p>
  <ul>
    <li class="toctree-11"><a class="reference internal" href="../../chpl-modindex.html">Chapel Module Index</a></li>
    <li class="toctree-11"><a class="reference internal" href="../../genindex.html">Complete Docs Index</a></li>
  </ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Chapel Documentation</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Tools</a></li>
      <li class="breadcrumb-item active">chplcheck</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tools/chplcheck/chplcheck.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="chplcheck">
<span id="readme-chplcheck"></span><h1>chplcheck<a class="headerlink" href="#chplcheck" title="Link to this heading">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> is a linter for the Chapel programming language implemented in
Python using the <a class="reference internal" href="../chapel-py/chapel-py.html#readme-chapel-py"><span class="std std-ref">Python bindings for the compiler frontend</span></a>.
It is intended to catch stylistic mistakes and bad practices in Chapel programs.
It is also intended to be customizable and extensible, using a system of named
‘rules’ that lead to warnings.</p>
<p><code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> supports the Language Server Protocol, allowing it to be used as
part of your favorite editor. The following image demonstrates its use in
Neovim:</p>
<img alt="Screenshot of code using ``chplcheck``" src="../../_images/neovim.png" />
<section id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Link to this heading">¶</a></h2>
<p>The easiest way to make <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> available on your command line is by using the
<code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> Makefile target. This will build the Dyno compiler frontend and the
Python bindings for Dyno if needed, and place <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> into <code class="docutils literal notranslate"><span class="pre">$CHPL_HOME/bin</span></code>.
Make sure that you satisfy <a class="reference internal" href="../chapel-py/chapel-py.html#chapel-py-installation"><span class="std std-ref">the requirements for building the Python bindings</span></a>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span><span class="nv">$CHPL_HOME</span>
make<span class="w"> </span>chplcheck
chplcheck<span class="w"> </span>--help
</pre></div>
</div>
<p>Saving the following file into <code class="docutils literal notranslate"><span class="pre">myfile.chpl</span></code>:</p>
<div class="highlight-chapel notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">record</span> <span class="nc">MyRecord</span> <span class="p">{}</span>
<span class="linenos">2</span>
<span class="linenos">3</span><span class="k">for</span> <span class="nx">i</span> <span class="kd">in</span> <span class="mi">1</span><span class="o">..</span><span class="mi">10</span> <span class="k">do</span> <span class="p">{</span>
<span class="linenos">4</span>  <span class="nx">writeln</span><span class="p">(</span><span class="s">&quot;Hello, world!&quot;</span><span class="p">);</span>
<span class="linenos">5</span><span class="p">}</span>
</pre></div>
</div>
<p>The linter is run as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span>chplcheck<span class="w"> </span>myfile.chpl
path/to/myfile/myfile.chpl:1:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>CamelCaseRecords
path/to/myfile/myfile.chpl:3:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>DoKeywordAndBlock
path/to/myfile/myfile.chpl:3:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>UnusedLoopIndex
</pre></div>
</div>
</section>
<section id="enabling-disabling-rules">
<h2>Enabling / Disabling Rules<a class="headerlink" href="#enabling-disabling-rules" title="Link to this heading">¶</a></h2>
<p>Each rule, such as <code class="docutils literal notranslate"><span class="pre">CamelCaseRecords</span></code>, can be individually enabled or
disabled from the command line using <code class="docutils literal notranslate"><span class="pre">--enable-rule</span></code> and <code class="docutils literal notranslate"><span class="pre">--disable-rule</span></code>.
To silence the warning about unused loop indices such as <code class="docutils literal notranslate"><span class="pre">i</span></code> in the above
code, we can invoke <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span>chplcheck<span class="w"> </span>myfile.chpl<span class="w"> </span>--disable-rule<span class="w"> </span>UnusedLoopIndex
path/to/myfile/myfile.chpl:1:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>CamelCaseRecords
path/to/myfile/myfile.chpl:3:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>DoKeywordAndBlock
</pre></div>
</div>
<p>Some rules are disabled by default. One such rule is <code class="docutils literal notranslate"><span class="pre">UseExplicitModules</span></code>, which
warns against letting Chapel automatically create the top-level module in a file.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span>chplcheck<span class="w"> </span>myfile.chpl<span class="w"> </span>--enable-rule<span class="w"> </span>UseExplicitModules
path/to/myfile/myfile.chpl:1:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>CamelCaseRecords
path/to/myfile/myfile.chpl:1:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>UseExplicitModules
path/to/myfile/myfile.chpl:3:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>DoKeywordAndBlock
path/to/myfile/myfile.chpl:3:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>UnusedLoopIndex
</pre></div>
</div>
<p>To get a list of all available rules, use the <code class="docutils literal notranslate"><span class="pre">--list-rules</span></code> flag. To see
which rules are currently enabled, use the <code class="docutils literal notranslate"><span class="pre">--list-active-rules</span></code> flag. If you
have <a class="reference external" href="#adding-custom-rules">loaded custom rules</a>, these will be included
in the output.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span>chplcheck<span class="w"> </span>--list-rules
...
&gt;<span class="w"> </span>chplcheck<span class="w"> </span>--list-active-rules
...
</pre></div>
</div>
<p>Rules can also be ignored on a case-by-case basis by adding a
<code class="docutils literal notranslate"><span class="pre">&#64;chplcheck.ignore</span></code> attribute with a string argument stating the rule to
ignore. For example:</p>
<div class="highlight-chapel notranslate"><div class="highlight"><pre><span></span><span class="k">@</span><span class="nd">chplcheck.ignore</span><span class="p">(</span><span class="s">&quot;CamelCaseRecords&quot;</span><span class="p">)</span>
<span class="k">record</span> <span class="nc">MyRecord</span> <span class="p">{}</span>
</pre></div>
</div>
<p>This will suppress the warning about <code class="docutils literal notranslate"><span class="pre">MyRecord</span></code> not being in camelCase.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">chplcheck.ignore</span></code> is a Chapel attribute and is subject to the same
limitations as other attributes in the language. This means that it cannot be used to ignore all warnings; for
example it currently cannot be used on an <code class="docutils literal notranslate"><span class="pre">if</span></code> statement.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is currently no way to ignore more than one rule at at time for a
given statement. Adding multiple <code class="docutils literal notranslate"><span class="pre">chplcheck.ignore</span></code> annotations will
result in a compilation error.</p>
</div>
</section>
<section id="fixits">
<h2>Fixits<a class="headerlink" href="#fixits" title="Link to this heading">¶</a></h2>
<p>Some rules have fixits associated with them. Fixits are suggestions for how to
resolve a given issue, either by editing the code or by adding
<code class="docutils literal notranslate"><span class="pre">&#64;chplcheck.ignore</span></code>. If using <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> as a command line tool, you can
apply these fixits by using the <code class="docutils literal notranslate"><span class="pre">--fixit</span></code> flag. When using <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> from
an editor, the editor may provide a way to apply fixits directly with a Quick
Fix.</p>
<p>When using the command line, a few additional flags are available to control how
fixits are applied:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--fixit</span></code>: Apply fixits to the file. By default, this is done in-place,
overwriting the original file with the fixed version.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--fixit-suffix</span> <span class="pre">&lt;suffix&gt;</span></code>: Apply fixits to a new file with the given suffix
appended to the original file name. For example, <code class="docutils literal notranslate"><span class="pre">--fixit-suffix</span> <span class="pre">.fixed</span></code>
would create a new file named <code class="docutils literal notranslate"><span class="pre">myfile.chpl.fixed</span></code> with the fixits applied.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--interactive</span></code>: Starts an interactive session where you can choose which
fixits to apply.</p></li>
</ul>
</section>
<section id="setting-up-in-your-editor">
<h2>Setting Up In Your Editor<a class="headerlink" href="#setting-up-in-your-editor" title="Link to this heading">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> uses the Language Server Protocol (LSP) to integrate with compatible
clients. If your editor supports LSP, you can configure it to display
linting warnings via <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code>. See the
<a class="reference internal" href="../../usingchapel/editor-support.html#readme-editor-support"><span class="std std-ref">Editor Support page</span></a> for details on a specific
editor.</p>
</section>
<section id="writing-new-rules">
<h2>Writing New Rules<a class="headerlink" href="#writing-new-rules" title="Link to this heading">¶</a></h2>
<p>Rules are written using the <a class="reference internal" href="../chapel-py/chapel-py.html#readme-chapel-py"><span class="std std-ref">Python bindings for Chapel’s compiler frontend</span></a>. In
essence, a rule is a Python function that is used to detect issues with the
AST. When registered with <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code>, the name of the function becomes the name
of the rule (which can be used to enable and disable the rule, as per the
above sections). To mark a Python function as representing a rule,
<code class="docutils literal notranslate"><span class="pre">chplcheck</span></code>’s Python API provides two decorators. These decorators correspond
to the two ‘flavors’ of rules in the linter: ‘basic’ and ‘advanced’.</p>
<section id="basic-rules">
<h3>Basic Rules<a class="headerlink" href="#basic-rules" title="Link to this heading">¶</a></h3>
<p>Basic rules are specified using a <a class="reference internal" href="../chapel-py/chapel-py.html#chapel-py-pattern-matching"><span class="std std-ref">pattern</span></a>.
This pattern represents which AST nodes should be scrutinized to check if something.
The <code class="docutils literal notranslate"><span class="pre">driver.basic_rule</span></code> decorator is used to specify such rules. For instance,
the following basic rule checks that explicit modules have <code class="docutils literal notranslate"><span class="pre">PascalCase</span></code> naming:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@driver</span><span class="o">.</span><span class="n">basic_rule</span><span class="p">(</span><span class="n">Module</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">PascalCaseModules</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">kind</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;implicit&quot;</span> <span class="ow">or</span> <span class="n">check_pascal_case</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Module</span></code> argument to <code class="docutils literal notranslate"><span class="pre">basic_rule</span></code> specifies that the linter should call
the <code class="docutils literal notranslate"><span class="pre">PascalCaseModules</span></code> function with each <code class="docutils literal notranslate"><span class="pre">Module</span></code> node it encounters. If
the function returns <code class="docutils literal notranslate"><span class="pre">True</span></code>, no warning should be emitted. If the function
returns <code class="docutils literal notranslate"><span class="pre">False</span></code>, the linter should produce a warning. The conditional returns
<code class="docutils literal notranslate"><span class="pre">True</span></code> for all implicit modules, regardless of their name: this is because
implicit modules are named after the file they are in, so the user cannot “fix”
the code by editing it. For explicit modules, a helper function
<code class="docutils literal notranslate"><span class="pre">check_pascal_case</span></code> is used to ensure that the node’s name is appropriately
cased.</p>
<p>Patterns can be more advanced than simply specifying an AST node type. The
following rule makes more use of patterns by specifying that it should be
applied only to <code class="docutils literal notranslate"><span class="pre">if</span></code>-statements that just have a boolean literal as their
condition.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@driver</span><span class="o">.</span><span class="n">basic_rule</span><span class="p">([</span><span class="n">Conditional</span><span class="p">,</span> <span class="n">BoolLiteral</span><span class="p">,</span> <span class="n">chapel</span><span class="o">.</span><span class="n">rest</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">BoolLitInCondStmt</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">False</span>
</pre></div>
</div>
</section>
<section id="advanced-rules">
<h3>Advanced Rules<a class="headerlink" href="#advanced-rules" title="Link to this heading">¶</a></h3>
<p>Sometimes, specifying a pattern is not precise enough to implement a rule. For
example, a linting check might require considering two sibling nodes or other
less-straightforward relationships than “does it match the pattern?”. This is
the purpose of advanced rules. These functions are called with the <em>root</em> AST
node (usually a top-level <code class="docutils literal notranslate"><span class="pre">Module</span></code>). Then, it is the responsibility
of the function to find and <code class="docutils literal notranslate"><span class="pre">yield</span></code> AST nodes that should be warned about.
For instance, at the time of writing, the following code implements the rule
checking for unused formals.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@driver</span><span class="o">.</span><span class="n">advanced_rule</span>
<span class="k">def</span> <span class="nf">UnusedFormal</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
    <span class="n">formals</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">uses</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">formal</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">chapel</span><span class="o">.</span><span class="n">each_matching</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">Formal</span><span class="p">):</span>
        <span class="c1"># For now, it&#39;s harder to tell if we&#39;re ignoring &#39;this&#39; formals</span>
        <span class="c1"># (what about method calls with implicit receiver?). So skip</span>
        <span class="c1"># &#39;this&#39; formals.</span>
        <span class="k">if</span> <span class="n">formal</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;this&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># extern functions have no bodies that can use their formals.</span>
        <span class="k">if</span> <span class="n">formal</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">linkage</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;extern&quot;</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">formals</span><span class="p">[</span><span class="n">formal</span><span class="o">.</span><span class="n">unique_id</span><span class="p">()]</span> <span class="o">=</span> <span class="n">formal</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">use</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="n">chapel</span><span class="o">.</span><span class="n">each_matching</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">Identifier</span><span class="p">):</span>
        <span class="n">refersto</span> <span class="o">=</span> <span class="n">use</span><span class="o">.</span><span class="n">to_node</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">refersto</span><span class="p">:</span>
            <span class="n">uses</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">refersto</span><span class="o">.</span><span class="n">unique_id</span><span class="p">())</span>

    <span class="k">for</span> <span class="n">unused</span> <span class="ow">in</span> <span class="n">formals</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">-</span> <span class="n">uses</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">formals</span><span class="p">[</span><span class="n">unused</span><span class="p">]</span>
</pre></div>
</div>
<p>This function performs _two_ pattern-based searches: one for formals, and one
for identifiers that might reference the formals. It then emits a warning for
each formal for which there wasn’t a corresponding identifier.</p>
</section>
<section id="making-rules-ignorable">
<h3>Making Rules Ignorable<a class="headerlink" href="#making-rules-ignorable" title="Link to this heading">¶</a></h3>
<p>The linter has a mechanism for marking a rule as supporting the <code class="docutils literal notranslate"><span class="pre">&#64;chplcheck.ignore</span></code> attribute. When rules are marked as such, the linter will automatically
provide a <a class="reference external" href="#writing-fixits">fixit</a> to apply the attribute.</p>
<p>Ignorable basic rules should return <code class="docutils literal notranslate"><span class="pre">BasicRuleResult</span></code> with <code class="docutils literal notranslate"><span class="pre">ignorable</span></code> set
to <code class="docutils literal notranslate"><span class="pre">True</span></code> rather than just a boolean. The <code class="docutils literal notranslate"><span class="pre">BasicRuleResult</span></code> constructor
takes a <code class="docutils literal notranslate"><span class="pre">AstNode</span></code> as an argument, which is the node that the rule is being
applied to. For example, the following defines a basic rule that is ignorable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@driver</span><span class="o">.</span><span class="n">basic_rule</span><span class="p">(</span><span class="n">chapel</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">NoFunctionFoo</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;foo&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BasicRuleResult</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ignorable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<p>Ignorable advanced rules should yield a <code class="docutils literal notranslate"><span class="pre">AdvancedRuleResult</span></code> with <code class="docutils literal notranslate"><span class="pre">anchor</span></code>
set rather than just a <code class="docutils literal notranslate"><span class="pre">AstNode</span></code>. The <code class="docutils literal notranslate"><span class="pre">AdvancedRuleResult</span></code> constructor
takes an <code class="docutils literal notranslate"><span class="pre">AstNode</span></code> as an argument, which is the node that the rule is being
applied to. The <code class="docutils literal notranslate"><span class="pre">anchor</span></code> is the node should have a <code class="docutils literal notranslate"><span class="pre">&#64;chplcheck.ignore</span></code>
annotation to suppress the warning. <code class="docutils literal notranslate"><span class="pre">anchor</span></code> and <code class="docutils literal notranslate"><span class="pre">node</span></code> can be the same
node. For example, the following defines an advanced rule that is ignorable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@driver</span><span class="o">.</span><span class="n">advanced_rule</span>
<span class="k">def</span> <span class="nf">NoLoopIndexI</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">root</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">loop</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">chapel</span><span class="o">.</span><span class="n">each_matching</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">IndexableLoop</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">index</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">idx</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">AdvancedRuleResult</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="n">loop</span><span class="p">)</span>
</pre></div>
</div>
<p>Since loop indices can’t have attributes applied to them directly, the rule above uses the parent loop as an anchor. Applying the attribute to the loop will silence the warning on the index.</p>
</section>
<section id="writing-fixits">
<span id="id1"></span><h3>Fixits<a class="headerlink" href="#writing-fixits" title="Link to this heading">¶</a></h3>
<p>Rules can have fixits associated with them, which allow <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> to
automatically resolve issues it encounters. To define a fixit, the rule should
construct a <code class="docutils literal notranslate"><span class="pre">Fixit</span></code> object and associate it with its result
(<code class="docutils literal notranslate"><span class="pre">BasicRuleResult</span></code> or <code class="docutils literal notranslate"><span class="pre">AdvancedRuleResult</span></code> for basic and advanced rules,
respectively). This can be done in two ways (see below).</p>
<p>A <code class="docutils literal notranslate"><span class="pre">Fixit</span></code> contains a list of <code class="docutils literal notranslate"><span class="pre">Edit</span></code> objects to apply to the code and an
optional description, which is shown to the user when the fixit is applied.
<code class="docutils literal notranslate"><span class="pre">Edit</span></code> objects contain a file path, a range defined by start and end
positions, and the text to replace inside of that range. The recommend way to
create an <code class="docutils literal notranslate"><span class="pre">Edit</span></code> object is to use the <code class="docutils literal notranslate"><span class="pre">Edit.build</span></code> class method, which
takes a <code class="docutils literal notranslate"><span class="pre">chapel.Location</span></code> and the text to replace it with.</p>
<p>For example, the following defines a rule that has a fixit associated with it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@driver</span><span class="o">.</span><span class="n">basic_rule</span><span class="p">(</span><span class="n">chapel</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">NoFunctionFoo</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;foo&quot;</span><span class="p">:</span>
        <span class="n">fixit</span> <span class="o">=</span> <span class="n">Fixit</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">Edit</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">name_location</span><span class="p">(),</span> <span class="s2">&quot;bar&quot;</span><span class="p">))</span>
        <span class="n">fixit</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Replace &#39;foo&#39; with &#39;bar&#39;&quot;</span>
        <span class="k">return</span> <span class="n">BasicRuleResult</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">fixits</span><span class="o">=</span><span class="p">[</span><span class="n">fixit</span><span class="p">])</span>
    <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The fixit for ‘NoFunctionFoo’ demonstrated here is not production-ready.
It does not rename the uses of the function, nor does it check for conflicts
with other names in the file. It is intended only to demonstrate the API for
defining fixits. The same is true for various other versions of this
example in this section.</p>
</div>
<p>The above code snippet directly uses a <code class="docutils literal notranslate"><span class="pre">fixits=</span></code> argument to the
<code class="docutils literal notranslate"><span class="pre">BasicRuleResult</span></code> constructor. This is one of two ways to associate fixits with
rules. Both advanced and basic rule results support this constructor argument.</p>
<p>Constructing the <code class="docutils literal notranslate"><span class="pre">Edit</span></code> objects can become relatively complicated for more
powerful auto-fixes. In practice, <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code> developers have observed
that the code to construct the necessary edits can be longer than the code
implementing the rule. To provide a separation of concerns between
“what should be warned about” and “how to fix the warning”, <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code>
provides a second mechanism to attach fixits to rules: the <code class="docutils literal notranslate"><span class="pre">&#64;driver.fixit</span></code>
decorator.</p>
<p>This decorator accepts the rule-to-be-fixed as an argument, and wraps a function
that accepts the result of the rule. The wrapped function should use
the information returned by the rule to construct a <code class="docutils literal notranslate"><span class="pre">Fixit</span></code> object or a list of
<code class="docutils literal notranslate"><span class="pre">Fixit</span></code> objects.</p>
<p>For example, the snippet above can be written using the decorator as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@driver</span><span class="o">.</span><span class="n">basic_rule</span><span class="p">(</span><span class="n">chapel</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">NoFunctionFoo</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;foo&quot;</span>

<span class="nd">@driver</span><span class="o">.</span><span class="n">fixit</span><span class="p">(</span><span class="n">NoFunctionFoo</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">FixNoFunctionFoo</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">BasicRuleResult</span><span class="p">):</span>
    <span class="n">fixit</span> <span class="o">=</span> <span class="n">Fixit</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">Edit</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name_location</span><span class="p">(),</span> <span class="s2">&quot;bar&quot;</span><span class="p">))</span>
    <span class="n">fixit</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Replace &#39;foo&#39; with &#39;bar&#39;&quot;</span>
    <span class="k">return</span> <span class="n">fixit</span>
</pre></div>
</div>
<p>Multiple fixits can be attached to a rule by using the <code class="docutils literal notranslate"><span class="pre">&#64;driver.fixit</span></code> decorator
several times.</p>
<p>Particularly complicated rules can do a number of AST traversals and computations
to determine whether a warning should be emitted. The information gathered
in the process of these computations may be required to issue a fixit. When
using the <code class="docutils literal notranslate"><span class="pre">&#64;driver.fixit</span></code> decorator, it appears as though this information
is lost. To address this, both <code class="docutils literal notranslate"><span class="pre">BasicRuleResult</span></code> and <code class="docutils literal notranslate"><span class="pre">AdvancedRuleResult</span></code>
accept an additional <code class="docutils literal notranslate"><span class="pre">data</span></code> argument. This argument can be of any type.
When decorator-based fixit functions are invoked, this <code class="docutils literal notranslate"><span class="pre">data</span></code> can be accessed
as a field on the result object.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@driver</span><span class="o">.</span><span class="n">basic_rule</span><span class="p">(</span><span class="n">chapel</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">NoFunctionFoo</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;foo&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BasicRuleResult</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data&quot;</span><span class="p">)</span>
    <span class="k">return</span>

<span class="nd">@driver</span><span class="o">.</span><span class="n">fixit</span><span class="p">(</span><span class="n">NoFunctionFoo</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">FixNoFunctionFoo</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">BasicRuleResult</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># prints &quot;some data&quot;</span>
    <span class="n">fixit</span> <span class="o">=</span> <span class="n">Fixit</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">Edit</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">name_location</span><span class="p">(),</span> <span class="s2">&quot;bar&quot;</span><span class="p">))</span>
    <span class="n">fixit</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;Replace &#39;foo&#39; with &#39;bar&#39;&quot;</span>
    <span class="k">return</span> <span class="n">fixit</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The API for defining fixits is still under development and may change in the
future.</p>
</div>
</section>
</section>
<section id="adding-custom-rules">
<h2>Adding Custom Rules<a class="headerlink" href="#adding-custom-rules" title="Link to this heading">¶</a></h2>
<p>Developers may have their own preferences for their code they would like to be
enforced by a linter. Rather than adding their own rule to <code class="docutils literal notranslate"><span class="pre">rules.py</span></code>,
developers can load a custom rule file that contains all of their custom rules.</p>
<p>For example, the following code is a complete definition of two new rules for
<code class="docutils literal notranslate"><span class="pre">chplcheck</span></code>. Note that the top-level function must be named <code class="docutils literal notranslate"><span class="pre">rules</span></code> and take
one argument.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># saved in file `myrules.py`</span>
<span class="kn">import</span> <span class="nn">chapel</span>

<span class="k">def</span> <span class="nf">rules</span><span class="p">(</span><span class="n">driver</span><span class="p">):</span>

  <span class="nd">@driver</span><span class="o">.</span><span class="n">basic_rule</span><span class="p">(</span><span class="n">chapel</span><span class="o">.</span><span class="n">Function</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">NoFunctionFoo</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;foo&quot;</span>

  <span class="nd">@driver</span><span class="o">.</span><span class="n">basic_rule</span><span class="p">(</span><span class="n">chapel</span><span class="o">.</span><span class="n">Variable</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">NoVariableBar</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;bar&quot;</span>
</pre></div>
</div>
<p>To use these rules with <code class="docutils literal notranslate"><span class="pre">chplcheck</span></code>, use the <code class="docutils literal notranslate"><span class="pre">--add-rules</span></code> command line
argument.</p>
<p>Saving the following file into <code class="docutils literal notranslate"><span class="pre">myfile.chpl</span></code>:</p>
<div class="highlight-chapel notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="k">proc</span> <span class="nf">foo</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">2</span>  <span class="kd">var</span> <span class="nx">bar</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="linenos">3</span><span class="p">}</span>
</pre></div>
</div>
<p>The linter is run as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&gt;<span class="w"> </span>chplcheck<span class="w"> </span>myfile.chpl<span class="w"> </span>--add-rules<span class="w"> </span>path/to/my/myrules.py<span class="w"> </span>--enable-rule<span class="w"> </span>NoVariableBar
path/to/myfile/myfile.chpl:1:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>NoFunctionFoo
path/to/myfile/myfile.chpl:2:<span class="w"> </span>node<span class="w"> </span>violates<span class="w"> </span>rule<span class="w"> </span>NoVariableBar
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../chpl-language-server/chpl-language-server.html" class="btn btn-neutral float-left" title="chpl-language-server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../chplvis/chplvis.html" class="btn btn-neutral float-right" title="chplvis" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Hewlett Packard Enterprise Development LP.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
 



</body>
</html>