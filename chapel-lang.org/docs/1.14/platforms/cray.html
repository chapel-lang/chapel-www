

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Using Chapel on Cray Systems &mdash; Chapel Documentation 1.14</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
  

  
    <link rel="top" title="Chapel Documentation 1.14" href="../index.html"/>
        <link rel="up" title="Platform-Specific Notes" href="index.html"/>
        <link rel="next" title="Using Chapel on Cygwin" href="cygwin.html"/>
        <link rel="prev" title="Platform-Specific Notes" href="index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> Chapel Documentation
          

          
          </a>

          
            
            
          

          
<?php   // Variables given by sphinx 
   $chplTitle = "1.14";   $pagename = "./platforms/cray";   include "../versionButton.php";   ?>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Compiling and Running Chapel</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/QUICKSTART.html">Quickstart Instructions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../usingchapel/index.html">Using Chapel</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Platform-Specific Notes</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="">Using Chapel on Cray Systems</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#getting-started-with-chapel-on-cray-x-series-systems">Getting Started with Chapel on Cray X-Series Systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getting-started-with-chapel-on-cray-cs-systems">Getting Started with Chapel on Cray CS Systems</a></li>
<li class="toctree-l3"><a class="reference internal" href="#building-chapel-for-a-cray-system-from-source">Building Chapel for a Cray System from Source</a></li>
<li class="toctree-l3"><a class="reference internal" href="#using-chapel-on-a-cray-system">Using Chapel on a Cray System</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cray-file-systems-and-chapel-execution">Cray File Systems and Chapel execution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#special-notes-for-cray-xc-xe-and-xk-series-systems">Special Notes for Cray XC, XE, and XK Series Systems</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#controlling-the-heap-size">Controlling the Heap Size</a></li>
<li class="toctree-l4"><a class="reference internal" href="#native-runtime-layers">Native Runtime Layers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-the-ugni-communications-layer">Using the ugni Communications Layer</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-the-muxed-tasking-layer">Using the muxed Tasking Layer</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#network-atomics">Network Atomics</a></li>
<li class="toctree-l3"><a class="reference internal" href="#known-constraints-and-bugs">Known Constraints and Bugs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#nccs-user-notes">NCCS user notes</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cygwin.html">Using Chapel on Cygwin</a></li>
<li class="toctree-l2"><a class="reference internal" href="ibm.html">Using Chapel on IBM Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="infiniband.html">Using Chapel with InfiniBand</a></li>
<li class="toctree-l2"><a class="reference internal" href="knl.html">Using Chapel on Intel &quot;Knights Landing&quot;</a></li>
<li class="toctree-l2"><a class="reference internal" href="macosx.html">Using Chapel on Mac OS X</a></li>
<li class="toctree-l2"><a class="reference internal" href="marenostrum.html">Using Chapel on MareNostrum</a></li>
<li class="toctree-l2"><a class="reference internal" href="sgi.html">Using Chapel on SGI Altix</a></li>
<li class="toctree-l2"><a class="reference internal" href="udp.html">Using the Portable UDP Conduit</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../technotes/index.html">Technical Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tools/index.html">Tools</a></li>
</ul>
<p class="caption"><span class="caption-text">Writing Chapel Programs</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../language/reference.html">Quick Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../examples/index.html">Hello World Variants</a></li>
<li class="toctree-l1"><a class="reference internal" href="../primers/index.html">Primers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/spec.html">Language Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../builtins.html">Built-in Types and Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/standard.html">Standard Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/packages.html">Package Modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../modules/layoutdist.html">Standard Layouts and Distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../users-guide/index.html">Chapel Users Guide (WIP)</a></li>
</ul>
<p class="caption"><span class="caption-text">Language History</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../language/evolution.html">Chapel Evolution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../language/archivedSpecs.html">Archived Language Specifications</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">Chapel Documentation 1.14</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Platform-Specific Notes</a> &raquo;</li>
      
    <li>Using Chapel on Cray Systems</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/platforms/cray.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="using-chapel-on-cray-systems">
<span id="readme-cray"></span><h1><a class="toc-backref" href="#id1">Using Chapel on Cray Systems</a><a class="headerlink" href="#using-chapel-on-cray-systems" title="Permalink to this headline">¶</a></h1>
<p>The following information is assembled to help Chapel users get up and running
on Cray® systems including the Cray XC™, XE™, XK™, and CS™ series systems.</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#using-chapel-on-cray-systems" id="id1">Using Chapel on Cray Systems</a><ul>
<li><a class="reference internal" href="#getting-started-with-chapel-on-cray-x-series-systems" id="id2">Getting Started with Chapel on Cray X-Series Systems</a></li>
<li><a class="reference internal" href="#getting-started-with-chapel-on-cray-cs-systems" id="id3">Getting Started with Chapel on Cray CS Systems</a></li>
<li><a class="reference internal" href="#building-chapel-for-a-cray-system-from-source" id="id4">Building Chapel for a Cray System from Source</a></li>
<li><a class="reference internal" href="#using-chapel-on-a-cray-system" id="id5">Using Chapel on a Cray System</a></li>
<li><a class="reference internal" href="#cray-file-systems-and-chapel-execution" id="id6">Cray File Systems and Chapel execution</a></li>
<li><a class="reference internal" href="#special-notes-for-cray-xc-xe-and-xk-series-systems" id="id7">Special Notes for Cray XC, XE, and XK Series Systems</a><ul>
<li><a class="reference internal" href="#controlling-the-heap-size" id="id8">Controlling the Heap Size</a></li>
<li><a class="reference internal" href="#native-runtime-layers" id="id9">Native Runtime Layers</a></li>
<li><a class="reference internal" href="#using-the-ugni-communications-layer" id="id10">Using the ugni Communications Layer</a><ul>
<li><a class="reference internal" href="#communication-layer-concurrency" id="id11">Communication Layer Concurrency</a></li>
<li><a class="reference internal" href="#communication-layer-concurrency-and-slurm" id="id12">Communication Layer Concurrency and Slurm</a></li>
</ul>
</li>
<li><a class="reference internal" href="#using-the-muxed-tasking-layer" id="id13">Using the muxed Tasking Layer</a><ul>
<li><a class="reference internal" href="#controlling-the-call-stack-size" id="id14">Controlling the Call Stack Size</a></li>
<li><a class="reference internal" href="#stack-overflow-checking" id="id15">Stack Overflow Checking</a></li>
<li><a class="reference internal" href="#number-of-threads-per-locale" id="id16">Number of Threads per Locale</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#network-atomics" id="id17">Network Atomics</a></li>
<li><a class="reference internal" href="#known-constraints-and-bugs" id="id18">Known Constraints and Bugs</a></li>
<li><a class="reference internal" href="#nccs-user-notes" id="id19">NCCS user notes</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="getting-started-with-chapel-on-cray-x-series-systems">
<h2><a class="toc-backref" href="#id2">Getting Started with Chapel on Cray X-Series Systems</a><a class="headerlink" href="#getting-started-with-chapel-on-cray-x-series-systems" title="Permalink to this headline">¶</a></h2>
<p>Chapel is available as a module for Cray X-series systems.  When it is
installed on your system, you do not need to build Chapel from the
source release (though you can). To use Chapel with the default settings and
confirm it is correctly installed, do the following:</p>
<ol class="arabic">
<li><p class="first">Load the Chapel module:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>module load chapel
</pre></div>
</div>
</li>
<li><p class="first">Compile an example program using:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>chpl -o hello6-taskpar-dist $CHPL_HOME/examples/hello6-taskpar-dist.chpl
</pre></div>
</div>
</li>
<li><p class="first">Execute the resulting executable (on four locales):</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>./hello6-taskpar-dist -nl 4
</pre></div>
</div>
</li>
</ol>
<p>This may be all that is necessary to use Chapel on a Cray X-Series system.
If the installation setup by your system administrator deviates from
the default settings, or you are interested in other configuration
options, see <a class="reference internal" href="#using-chapel-on-a-cray-system">Using Chapel on a Cray System</a> below.  If instead you wish to
build Chapel from source, continue on to
<a class="reference internal" href="#building-chapel-for-a-cray-system-from-source">Building Chapel for a Cray System from Source</a> just below.</p>
<p>For information on obtaining and installing the Chapel module please
contact your system administrator.</p>
</div>
<div class="section" id="getting-started-with-chapel-on-cray-cs-systems">
<h2><a class="toc-backref" href="#id3">Getting Started with Chapel on Cray CS Systems</a><a class="headerlink" href="#getting-started-with-chapel-on-cray-cs-systems" title="Permalink to this headline">¶</a></h2>
<p>On Cray CS systems, Chapel is not currently available as a module due
to the wide diversity of software packages that Cray CS customers may
choose to install on their system.  For this reason, Chapel must be
built from source on Cray CS systems using the
<a class="reference internal" href="#building-chapel-for-a-cray-system-from-source">Building Chapel for a Cray System from Source</a> instructions just below.</p>
</div>
<div class="section" id="building-chapel-for-a-cray-system-from-source">
<h2><a class="toc-backref" href="#id4">Building Chapel for a Cray System from Source</a><a class="headerlink" href="#building-chapel-for-a-cray-system-from-source" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">If using a XC, XE, or XK system, continue to step 2. If using a
CS series system, set <code class="docutils literal"><span class="pre">CHPL_HOST_PLATFORM</span></code> to <code class="docutils literal"><span class="pre">cray-cs</span></code>.</p>
<p>For example:</p>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_HOST_PLATFORM</span><span class="o">=</span>cray-cs
</pre></div>
</div>
</div></blockquote>
<p>These are the supported systems and strings.  Note that these values
are used by default when building on the given systems.  They can
also be set manually.  Also note that the <code class="docutils literal"><span class="pre">cray-xe</span></code> configuration
covers Cray XK systems as well as Cray XE systems.</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="33%" />
<col width="67%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">System</th>
<th class="head">CHPL_HOST_PLATFORM</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>CS series</td>
<td>cray-cs</td>
</tr>
<tr class="row-odd"><td>XC series</td>
<td>cray-xc</td>
</tr>
<tr class="row-even"><td>XE series</td>
<td>cray-xe</td>
</tr>
<tr class="row-odd"><td>XK series</td>
<td>cray-xe</td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first">Optionally, set the <code class="docutils literal"><span class="pre">CHPL_LAUNCHER</span></code> environment variable to indicate
how Chapel should launch jobs on your system:</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="62%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">On a Cray CS system, to...</th>
<th class="head">set CHPL_LAUNCHER to...</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>...run jobs interactively on your system</td>
<td>gasnetrun_ibv</td>
</tr>
<tr class="row-odd"><td>...queue jobs using PBSPro (qsub)</td>
<td>pbs-gasnetrun_ibv</td>
</tr>
<tr class="row-even"><td>...queue jobs using SLURM (sbatch)</td>
<td>slurm-gasnetrun_ibv</td>
</tr>
<tr class="row-odd"><td>...queue jobs using LSF (bsub)</td>
<td>lsf-gasnetrun_ibv</td>
</tr>
</tbody>
</table>
<table border="1" class="docutils">
<colgroup>
<col width="62%" />
<col width="38%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">On a Cray X-series system, to...</th>
<th class="head">set CHPL_LAUNCHER to...</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>...run jobs interactively on your system</td>
<td>aprun</td>
</tr>
<tr class="row-odd"><td>...queue jobs using PBS (qsub)</td>
<td>pbs-aprun</td>
</tr>
<tr class="row-even"><td>...queue jobs using SLURM (sbatch)</td>
<td>slurm-srun</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>You can also set CHPL_LAUNCHER to <code class="docutils literal"><span class="pre">none</span></code> if you prefer to manually
manage all queuing and job launch commands yourself.</p>
<p>On Cray CS systems, <code class="docutils literal"><span class="pre">CHPL_LAUNCHER</span></code> defaults to <code class="docutils literal"><span class="pre">gasnetrun_ibv</span></code>.</p>
<p>On Cray X-Series systems, <code class="docutils literal"><span class="pre">CHPL_LAUNCHER</span></code> defaults to <code class="docutils literal"><span class="pre">aprun</span></code> if
it is in your path; <code class="docutils literal"><span class="pre">none</span></code> otherwise.</p>
<p>For more information on Chapel's launcher capabilities and options,
refer to <a class="reference internal" href="../usingchapel/launcher.html#readme-launcher"><span>Chapel Launchers</span></a>.</p>
</li>
<li><p class="first">Select the target compiler that Chapel should use when compiling
code for the compute node:</p>
<p>On a Cray CS series system, set the <code class="docutils literal"><span class="pre">CHPL_TARGET_COMPILER</span></code> environment
variable to indicate which compiler to use (and make sure that the compiler
is in your path).</p>
<blockquote>
<div><table border="1" class="docutils">
<colgroup>
<col width="47%" />
<col width="53%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">To request...</th>
<th class="head">set CHPL_TARGET_COMPILER to...</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>...the GNU compiler (gcc)</td>
<td>gnu    (default)</td>
</tr>
<tr class="row-odd"><td>...the Intel compiler (icc)</td>
<td>intel</td>
</tr>
<tr class="row-even"><td>...the PGI compiler (pgcc)</td>
<td>pgi</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>On a Cray X-series system, ensure that you have one of the following
Programming Environment modules loaded to specify your target compiler:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">PrgEnv</span><span class="o">-</span><span class="n">cray</span>
<span class="n">PrgEnv</span><span class="o">-</span><span class="n">gnu</span>
<span class="n">PrgEnv</span><span class="o">-</span><span class="n">intel</span>
<span class="n">PrgEnv</span><span class="o">-</span><span class="n">pgi</span>
</pre></div>
</div>
<p>For PrgEnv-cray we recommend using CCE 8.4 or newer for best performance.
This allows us to build our recommended third-party packages (i.e. allows
us to default to CHPL_TASKS=qthreads instead of CHPL_TASKS=fifo)</p>
</li>
<li><p class="first">By default, <code class="docutils literal"><span class="pre">g++</span></code> will be used to compile code that runs on the login
node, such as the Chapel compiler and launcher code.  Optionally, you can
override this default by setting <code class="docutils literal"><span class="pre">CHPL_HOST_COMPILER</span></code> to one of the
following values:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name"><code class="docutils literal"><span class="pre">gnu</span></code>:</th><td class="field-body">the GNU compiler suite -- <code class="docutils literal"><span class="pre">gcc</span></code> and <code class="docutils literal"><span class="pre">g++</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name"><code class="docutils literal"><span class="pre">intel</span></code>:</th><td class="field-body">the Intel compiler suite -- <code class="docutils literal"><span class="pre">icc</span></code> and <code class="docutils literal"><span class="pre">icpc</span></code></td>
</tr>
<tr class="field-odd field"><th class="field-name"><code class="docutils literal"><span class="pre">pgi</span></code>:</th><td class="field-body">the PGI compiler suite -- <code class="docutils literal"><span class="pre">pgcc</span></code> and <code class="docutils literal"><span class="pre">pgc++</span></code></td>
</tr>
</tbody>
</table>
</div></blockquote>
</li>
<li><p class="first">Optionally, set one or more of the following environment variables to
configure the Chapel build.  These are described in greater detail in
<a class="reference internal" href="../usingchapel/chplenv.html#readme-chplenv"><span>Setting up Your Environment for Chapel</span></a>.</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name"><code class="docutils literal"><span class="pre">CHPL_TASKS</span></code>:</th><td class="field-body">tasking implementation, default <code class="docutils literal"><span class="pre">qthreads</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name"><code class="docutils literal"><span class="pre">CHPL_COMM</span></code>:</th><td class="field-body">communication implementation, default <code class="docutils literal"><span class="pre">gasnet</span></code></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>For CS™ series systems, see <a class="reference internal" href="infiniband.html#readme-infiniband"><span>Using Chapel with InfiniBand</span></a> for
information about using Chapel with InfiniBand.</p>
<p>Other configuration environment variables such as <code class="docutils literal"><span class="pre">CHPL_MEM</span></code> can also
be set, but this is more typical when doing internal development.
For production work the configuration scripts should always select an
appropriate default for these.</p>
<p>Note that the Cray-specific settings of <code class="docutils literal"><span class="pre">muxed</span></code> tasking and <code class="docutils literal"><span class="pre">ugni</span></code>
communications cannot be selected when building Chapel from source,
because the corresponding runtime layers are not distributed in
source form.  These settings can only be selected when using the
pre-built Chapel module.</p>
</li>
<li><p class="first">Make sure you're in the top-level chapel/ directory and make/re-make the
compiler and runtime:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">gmake</span>
</pre></div>
</div>
<p>Note that a single Chapel installation can support multiple
configurations simultaneously and that you can switch between them
simply by changing any of the above settings.  However, each
configuration must be built separately.  Thus, you can change any of
the settings in the steps before this, and then re-run this step in
order to create additional installations.  Thereafter, you can switch
between any of these configurations without rebuilding.</p>
</li>
</ol>
</div>
<div class="section" id="using-chapel-on-a-cray-system">
<h2><a class="toc-backref" href="#id5">Using Chapel on a Cray System</a><a class="headerlink" href="#using-chapel-on-a-cray-system" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">If you are working from a Chapel module:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>Load the module using <code class="docutils literal"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">chapel</span></code></li>
<li>Optionally select a launcher, as in step 2 above</li>
<li>Select a target compiler, as in step 3 above</li>
</ol>
</div></blockquote>
<p>If you are working from a source installation:</p>
<blockquote>
<div><ol class="loweralpha simple">
<li>Set your host platform as in step 1 above</li>
<li>Optionally select a launcher, as in step 2 above</li>
<li>Select a target compiler, as in step 3 above</li>
<li>Set <code class="docutils literal"><span class="pre">CHPL_HOME</span></code> and your paths by invoking the appropriate
<code class="docutils literal"><span class="pre">util/setchplenv</span></code> script for your shell.  For example:</li>
</ol>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">source</span> util/setchplenv.bash
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
</li>
<li><p class="first">Optionally, set one or more of the following environment variables to
select a Chapel configuration.  These are described in greater detail
in <a class="reference internal" href="../usingchapel/chplenv.html#readme-chplenv"><span>Setting up Your Environment for Chapel</span></a>.</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name"><code class="docutils literal"><span class="pre">CHPL_TASKS</span></code>:</th><td class="field-body">tasking implementation, default <code class="docutils literal"><span class="pre">qthreads</span></code></td>
</tr>
<tr class="field-even field"><th class="field-name"><code class="docutils literal"><span class="pre">CHPL_COMM</span></code>:</th><td class="field-body">communication implementation, default <code class="docutils literal"><span class="pre">ugni</span></code> on Cray
XC/XE with pre-built module, else <code class="docutils literal"><span class="pre">gasnet</span></code></td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>For CS™ series systems, see <a class="reference internal" href="infiniband.html#readme-infiniband"><span>Using Chapel with InfiniBand</span></a> for
information about using Chapel with InfiniBand.</p>
<p>Other configuration environment variables such as <code class="docutils literal"><span class="pre">CHPL_MEM</span></code> can also
be set, but this is more typical when doing internal development.
For production work the configuration scripts should always select an
appropriate default for these.</p>
<p>The configuration selected must be one that is present in the Chapel
installation being used, whether that is a source distribution or the
pre-built module.  If it is not, the Chapel compiler will produce an
error message saying so when you try to compile anything.  If you get
this error, you will need to build the desired configuration (if you
are working from source) or modify your configuration so that it is
one of those supplied (if you are working with the pre-built module).</p>
</li>
<li><p class="first">Compile your Chapel program.  For example:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span>chpl -o hello6-taskpar-dist <span class="nv">$CHPL_HOME</span>/examples/hello6-taskpar-dist.chpl
</pre></div>
</div>
<p>See <a class="reference internal" href="../usingchapel/compiling.html#readme-compiling"><span>Compiling Chapel Programs</span></a> or  <code class="docutils literal"><span class="pre">man</span> <span class="pre">chpl</span></code> for further details.</p>
</li>
<li><p class="first">If <code class="docutils literal"><span class="pre">CHPL_LAUNCHER</span></code> is set to anything other than <code class="docutils literal"><span class="pre">none</span></code>, when you
compile a Chapel program for your Cray system, you will see two
binaries (e.g., <code class="docutils literal"><span class="pre">hello6-taskpar-dist</span></code> and <code class="docutils literal"><span class="pre">hello6-taskpar-dist_real</span></code>).
The first binary contains code to launch the Chapel program onto
the compute nodes, as specified by your <code class="docutils literal"><span class="pre">CHPL_LAUNCHER</span></code> setting.  The
second contains the program code itself; it is not intended to be
executed directly from the shell prompt.</p>
<p>You can use the <code class="docutils literal"><span class="pre">-v</span></code> flag to see the commands used by the launcher
binary to start your program.</p>
<p>If <code class="docutils literal"><span class="pre">CHPL_LAUNCHER</span></code> is <code class="docutils literal"><span class="pre">pbs-aprun</span></code> or <code class="docutils literal"><span class="pre">pbs-gasnetrun_ibv</span></code>:</p>
<blockquote>
<div><ol class="loweralpha">
<li><p class="first">You can optionally specify a queue name using the environment
variable <code class="docutils literal"><span class="pre">CHPL_LAUNCHER_QUEUE</span></code>.  For example:</p>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_QUEUE</span><span class="o">=</span>batch
</pre></div>
</div>
</div></blockquote>
<p>If this variable is left unset, no queue name will be
specified.  Alternatively, you can set the queue name on your
Chapel program command line using the <code class="docutils literal"><span class="pre">--queue</span></code> flag.</p>
</li>
<li><p class="first">You can also optionally set a wall clock time limit for the
job using <code class="docutils literal"><span class="pre">CHPL_LAUNCHER_WALLTIME</span></code>.  For example to specify a
10-minute time limit, use:</p>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_WALLTIME</span><span class="o">=</span>00:10:00
</pre></div>
</div>
</div></blockquote>
<p>Alternatively, you can set the wall clock time limit on your
Chapel program command line using the <code class="docutils literal"><span class="pre">--walltime</span></code> flag.</p>
</li>
</ol>
</div></blockquote>
<p>If <code class="docutils literal"><span class="pre">CHPL_LAUNCHER</span></code> is <code class="docutils literal"><span class="pre">slurm-gasnetrun_ibv</span></code>:</p>
<blockquote>
<div><p>You must set the amount of time to request from SLURM.
For example, the following requests 15 minutes:</p>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_WALLTIME</span><span class="o">=</span>00:15:00
</pre></div>
</div>
</div></blockquote>
</div></blockquote>
<p>For further information about launchers, please refer to
<a class="reference internal" href="../usingchapel/launcher.html#readme-launcher"><span>Chapel Launchers</span></a>.</p>
</li>
<li><p class="first">Execute your Chapel program.  Multi-locale executions require the
number of locales (compute nodes) to be specified on the command
line.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>./hello6-taskpar-dist -nl 2
</pre></div>
</div>
<p>Requests the program to be executed using two locales.</p>
</li>
<li><p class="first">If your Cray system has compute nodes with varying numbers of
cores, you can request nodes with at least a certain number of
cores using the variable <code class="docutils literal"><span class="pre">CHPL_LAUNCHER_CORES_PER_LOCALE</span></code>.  For
example, on a Cray system in which some compute nodes have 24 or
more cores per compute node, you could request nodes with at least
24 cores using:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_CORES_PER_LOCALE</span><span class="o">=</span>24
</pre></div>
</div>
<p>This variable may be needed when you are using the aprun launcher and
running Chapel programs within batch jobs you are managing yourself.
The aprun launcher currently creates aprun commands that request the
maximum number of cores per locale found on any locale in the system,
irrespective of the fact that the batch job may have a lower limit
than that on the number of cores per locale.  If the batch job limit
is less than the maximum number of cores per locale, you will get the
following error message when you try to run a Chapel program:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>apsched: claim exceeds reservation&#39;s CPUs
</pre></div>
</div>
<p>You can work around this by setting <code class="docutils literal"><span class="pre">CHPL_LAUNCHER_CORES_PER_LOCALE</span></code> to
the same or lesser value as the number of cores per locale specified
for the batch job (for example, the mppdepth resource for the PBS
qsub command).  In the future we hope to achieve better integration
between Chapel launchers and workload managers.</p>
</li>
<li><p class="first">If your Cray system has compute nodes with varying numbers of CPUs
per compute unit, you can request nodes with a certain number of
CPUs per compute unit using the variable <code class="docutils literal"><span class="pre">CHPL_LAUNCHER_CPUS_PER_CU</span></code>.
For example, on a Cray XC series system with some nodes having at
least 2 CPUs per compute unit, to request running on those nodes
you would use:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_CPUS_PER_CU</span><span class="o">=</span>2
</pre></div>
</div>
<p>Currently, the only legal values for <code class="docutils literal"><span class="pre">CHPL_LAUNCHER_CPUS_PER_CU</span></code> are
0 (the default), 1, and 2.</p>
</li>
</ol>
<table border="1" class="docutils">
<colgroup>
<col width="58%" />
<col width="42%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">For more information on...</th>
<th class="head">see...</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>...CHPL_* environment settings</td>
<td><a class="reference internal" href="../usingchapel/chplenv.html#readme-chplenv"><span>Setting up Your Environment for Chapel</span></a></td>
</tr>
<tr class="row-odd"><td>...Compiling Chapel programs</td>
<td><a class="reference internal" href="../usingchapel/compiling.html#readme-compiling"><span>Compiling Chapel Programs</span></a></td>
</tr>
<tr class="row-even"><td>...Launcher options</td>
<td><a class="reference internal" href="../usingchapel/launcher.html#readme-launcher"><span>Chapel Launchers</span></a></td>
</tr>
<tr class="row-odd"><td>...Executing Chapel programs</td>
<td><a class="reference internal" href="../usingchapel/executing.html#readme-executing"><span>Executing Chapel Programs</span></a></td>
</tr>
<tr class="row-even"><td>...Running multi-locale Chapel programs</td>
<td><a class="reference internal" href="../usingchapel/multilocale.html#readme-multilocale"><span>Multilocale Chapel Execution</span></a></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="cray-file-systems-and-chapel-execution">
<h2><a class="toc-backref" href="#id6">Cray File Systems and Chapel execution</a><a class="headerlink" href="#cray-file-systems-and-chapel-execution" title="Permalink to this headline">¶</a></h2>
<p>For best results, it is recommended that you execute your Chapel
program by placing the binaries on a file system shared between the
login node and compute nodes (typically Lustre), as this will provide
the greatest degree of transparency when executing your program.  In
some cases, running a Chapel program from a non-shared file system
will make it impossible to launch onto the compute nodes.  In other
cases, the launch will succeed, but any files read or written by the
Chapel program will be opened relative to the compute node's file
system rather than the login node's.</p>
</div>
<div class="section" id="special-notes-for-cray-xc-xe-and-xk-series-systems">
<h2><a class="toc-backref" href="#id7">Special Notes for Cray XC, XE, and XK Series Systems</a><a class="headerlink" href="#special-notes-for-cray-xc-xe-and-xk-series-systems" title="Permalink to this headline">¶</a></h2>
<div class="section" id="controlling-the-heap-size">
<h3><a class="toc-backref" href="#id8">Controlling the Heap Size</a><a class="headerlink" href="#controlling-the-heap-size" title="Permalink to this headline">¶</a></h3>
<p>When running on Cray XC/XE/XK systems using either of the following
configurations, the comm layer needs to know the maximum size the
program heap will grow to during execution:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>CHPL_COMM=gasnet
  CHPL_COMM_SUBSTRATE=gemini or aries
  CHPL_GASNET_SEGMENT=fast or large
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>CHPL_COMM=ugni, with a craype-hugepages module loaded
</pre></div>
</div>
<p>With <code class="docutils literal"><span class="pre">CHPL_COMM=gasnet</span></code>, by default the heap will occupy as much of the
free memory on each locale (compute node) as the runtime can acquire,
less some amount to allow for demands from other (system) programs
running there.  With <code class="docutils literal"><span class="pre">CHPL_COMM=ugni</span></code> when a craype-hugepages module is
loaded, by default the heap will occupy 2/3 of the free memory on each
locale.  With the ugni comm layer and slurm job placement, however, this
default is reduced to 16 GiB if that is less.  See <a class="reference internal" href="#communication-layer-concurrency-and-slurm">Communication Layer
Concurrency and Slurm</a>, below, for more information.</p>
<p>Advanced users may want to make the heap smaller than this.  Programs
start more quickly with a smaller heap, and in the unfortunate event
that you need to produce core files, those will be written more quickly
if the heap is smaller.  However, note that if you reduce the heap size
to less than the amount your program actually needs and then run it, it
will terminate prematurely due to not having enough memory.</p>
<p>To change the heap size, set the <code class="docutils literal"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> environment
variable.  Set it to just a number to specify the size of the heap in
bytes, or to a number with a <code class="docutils literal"><span class="pre">k</span></code> or <code class="docutils literal"><span class="pre">K</span></code>, <code class="docutils literal"><span class="pre">m</span></code> or <code class="docutils literal"><span class="pre">M</span></code>, or <code class="docutils literal"><span class="pre">g</span></code> or <code class="docutils literal"><span class="pre">G</span></code>
suffix with no intervening spaces to specify the heap size in KiB (2^10
bytes), MiB (2^20 bytes), or GiB (2^30 bytes), respectively.  Any of the
following would set the heap size to 1 GiB, for example:</p>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_RT_MAX_HEAP_SIZE</span><span class="o">=</span>1073741824
<span class="nb">export</span> <span class="nv">CHPL_RT_MAX_HEAP_SIZE</span><span class="o">=</span>1048576k
<span class="nb">export</span> <span class="nv">CHPL_RT_MAX_HEAP_SIZE</span><span class="o">=</span>1024m
<span class="nb">export</span> <span class="nv">CHPL_RT_MAX_HEAP_SIZE</span><span class="o">=</span>1g
</pre></div>
</div>
</div></blockquote>
<p>Note that the value you set in <code class="docutils literal"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> may get rounded up
internally to match the page alignment.  How much, if any, this will add
depends on the hugepage size in any craype-hugepage module you have loaded at
the time you execute the program.</p>
<p>Note that for <code class="docutils literal"><span class="pre">CHPL_COMM=gasnet</span></code>, <code class="docutils literal"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> is synonymous with
<code class="docutils literal"><span class="pre">GASNET_MAX_SEGSIZE</span></code>, and the former overrides the latter if both are set.</p>
</div>
<div class="section" id="native-runtime-layers">
<h3><a class="toc-backref" href="#id9">Native Runtime Layers</a><a class="headerlink" href="#native-runtime-layers" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="../usingchapel/multilocale.html#readme-multilocale"><span>Multilocale Chapel Execution</span></a> and <a class="reference internal" href="../usingchapel/tasks.html#readme-tasks"><span>Chapel Tasks</span></a> pages
describe a variety of
communication and tasking layers that can be used by Chapel programs.
In addition to the standard runtime layers available in any Chapel
release, the pre-built Chapel module for Cray XC and XE series systems
supports Cray-specific communication and tasking layers.  These make use
of the Cray systems' hardware and/or software to produce enhanced
performance for Chapel programs.  When using the pre-built module on
Cray XC or XE systems the allowed combinations are ugni communications
with either qthreads (the default) or muxed tasking.  On other kinds of
Cray systems or when not using the pre-built module, the default is to
use gasnet communications and qthreads tasking.</p>
<p>Note that neither the ugni communication layer nor the muxed tasking
layer can be built from sources, as they are not distributed in source
form.</p>
<p>The ugni communication layer interacts with the system's network
interface very closely through a lightweight interface called uGNI (user
Generic Network Interface).  The muxed tasking layer switches Chapel
tasks and threads in a lightweight manner in user space, avoiding the
overhead and some of the resource limitations associated with OS thread
switching.  These layers cooperate to overlap communication to remote
locales with task execution, particularly improving the performance of
programs limited by the latency of small remote data references, such as
graph analytic applications.</p>
</div>
<div class="section" id="using-the-ugni-communications-layer">
<h3><a class="toc-backref" href="#id10">Using the ugni Communications Layer</a><a class="headerlink" href="#using-the-ugni-communications-layer" title="Permalink to this headline">¶</a></h3>
<p>To use ugni communications:</p>
<ol class="arabic">
<li><p class="first">Make sure that you are using either the GNU, Intel, or Cray target
compiler:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>module load PrgEnv-gnu
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>module load PrgEnv-intel
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>module load PrgEnv-cray
</pre></div>
</div>
<p>(If you have a different PrgEnv module loaded, you will have to
unload it first, or do a swap instead of a load.)</p>
</li>
<li><p class="first">Set your CHPL_COMM environment variable to <code class="docutils literal"><span class="pre">ugni</span></code>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_COMM</span><span class="o">=</span>ugni
</pre></div>
</div>
<p>This specifies that you wish to use the Cray-specific communication
layer.</p>
</li>
<li><p class="first">Set your CHPL_TASKS environment variable to <code class="docutils literal"><span class="pre">qthreads</span></code> (the
default), <code class="docutils literal"><span class="pre">muxed</span></code>, or <code class="docutils literal"><span class="pre">fifo</span></code>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_TASKS</span><span class="o">=</span>qthreads
</pre></div>
</div>
<p>or:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_TASKS</span><span class="o">=</span>muxed
</pre></div>
</div>
<p>or:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_TASKS</span><span class="o">=</span>fifo
</pre></div>
</div>
<p>All of these tasking layers work with ugni communications.  Other
Chapel environment variables having to do with runtime layers can
be left unset.  Setting <code class="docutils literal"><span class="pre">CHPL_COMM</span></code> and <code class="docutils literal"><span class="pre">CHPL_TASKS</span></code> like this
will cause the correct combination of other runtime layers that work
with those to be selected automatically.</p>
</li>
<li><p class="first"><em>(Optional)</em> Load an appropriate craype-hugepages module.  For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>module load craype-hugepages16M
</pre></div>
</div>
<p>The ugni communication layer can be used with or without so-called
<em>hugepages</em>.  Performance for remote variable references is better
when hugepages are used.  However, using hugepages effectively may
require setting <code class="docutils literal"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> to a value large enough to
encompass the program's memory needs (see <a class="reference internal" href="#controlling-the-heap-size">Controlling the Heap
Size</a>, above), and that quantity can be hard to know.  Using
hugepages also means that the tasking layer cannot use guard pages to
detect task stack overflows (see below).</p>
<p>To use hugepages, you must have a <code class="docutils literal"><span class="pre">craype-hugepages</span></code> module loaded
both when building your program and when running it.
There are several hugepage modules, with suffixes indicating the page
size they support.  For example, <code class="docutils literal"><span class="pre">craype-hugepages16M</span></code> supports 16 MiB
hugepages.  It does not matter which <code class="docutils literal"><span class="pre">craype-hugepages</span></code> module you have
loaded when you build your program.  Any of them will do.  However,
which one you have loaded when you run your program does matter.  For
general use, the Chapel group recommends the <code class="docutils literal"><span class="pre">craype-hugepages16M</span></code>
module.  You can read on for more information about <code class="docutils literal"><span class="pre">craype-hugepage</span></code>
modules if you would like, but the recommended <code class="docutils literal"><span class="pre">craype-hugepages16M</span></code>
module will probably give you satisfactory results.</p>
<p>The architecture of the Cray network interface chips (NICs) limits
them to addressing at most 16k (2**14) pages of memory.  This is
sufficient to cover a 32 GiB Cray XC locale with 2 MiB pages.  But
if you will be running on 64 GiB locales, you will need to use at
least 4 MiB pages to cover all of the memory.  Generally, using
larger hugepage sizes results in modest performance benefits,
mostly in program startup time.  The <code class="docutils literal"><span class="pre">craype-hugepages16M</span></code> module
will result in slightly faster program startup, and its 16 MiB
hugepages will cover the locale memory on any Cray X-series system.</p>
<p>The only downside to larger page sizes is that they can waste more
memory than smaller page sizes do, when the data segments that reside
on them are smaller than the hugepage size (which is often the case).
In practice, however, the effect of this is minor.  Even using the
fairly large 16 MiB hugepages will typically only result in around 1%
of the total locale memory being wasted.</p>
</li>
</ol>
<p>When hugepages are used with the ugni comm layer, tasking layers
cannot use guard pages for stack overflow detection.  Qthreads tasking
can only use guard pages for stack overflow detection, so if ugni
communications is combined with qthreads tasking, overflow detection is
turned off completely.  Muxed tasking can use guard pages for stack
overflow detection, but it can also drop back to synchronous overflow
detection, as described below, with <code class="docutils literal"><span class="pre">CHPL_COMM=ugni</span></code> and hugepages.</p>
<p>There is one special parameter recognized by the ugni communication
layer:</p>
<div class="section" id="communication-layer-concurrency">
<h4><a class="toc-backref" href="#id11">Communication Layer Concurrency</a><a class="headerlink" href="#communication-layer-concurrency" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal"><span class="pre">CHPL_RT_COMM_CONCURRENCY</span></code> environment variable tells the ugni
communication layer how much program concurrency it should try to
support.  This basically controls how much of the communication
resources on the NIC will be used by the program.  The default
value is the number of hardware processor cores the program will
use for Chapel tasks (<code class="docutils literal"><span class="pre">CHPL_RT_NUM_HARDWARE_THREADS</span></code> in the next
section).  Usually this is enough, but for highly parallel codes
that do a lot of remote references, increasing it may help the
performance.  Useful values for <code class="docutils literal"><span class="pre">CHPL_RT_COMM_CONCURRENCY</span></code> are in
the range 1 to 30.  Values specified outside this range are
silently increased or reduced so as to fall within it.</p>
</div>
<div class="section" id="communication-layer-concurrency-and-slurm">
<h4><a class="toc-backref" href="#id12">Communication Layer Concurrency and Slurm</a><a class="headerlink" href="#communication-layer-concurrency-and-slurm" title="Permalink to this headline">¶</a></h4>
<p>When slurm is used for job placement on Cray systems, it limits the
total NIC memory registration in order to allow for job sharing on
the compute nodes.  In our experience this limit is approximately
240 GiB.  The product of <code class="docutils literal"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> and the communication
layer concurrency discussed above must be less than this.  The ugni
communication layer adjusts its heap size and concurrency defaults
to reflect this limit when slurm is used for job placement.  The
default heap size is reduced to 16 GiB.  The concurrency is computed
such that the product of heap size and concurrency is below 240 GiB.
Thus under slurm, the ugni communication layer can support programs
with very large heaps or programs that need a lot of communication
concurrency, but not programs that need both simultaneously.  Such
programs need to be run on a system that uses ALPS instead of slurm
for job placement.</p>
</div>
</div>
<div class="section" id="using-the-muxed-tasking-layer">
<h3><a class="toc-backref" href="#id13">Using the muxed Tasking Layer</a><a class="headerlink" href="#using-the-muxed-tasking-layer" title="Permalink to this headline">¶</a></h3>
<p>To use muxed tasking:</p>
<ol class="arabic">
<li><p class="first">Make sure that you are using either the GNU, Intel, or Cray target
compiler:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>module load PrgEnv-gnu
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>module load PrgEnv-intel
</pre></div>
</div>
<p>or:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>module load PrgEnv-cray
</pre></div>
</div>
<p>(If you have a different PrgEnv module loaded, you will have to
unload it first, or do a swap instead of a load.)</p>
</li>
<li><p class="first">Set your <code class="docutils literal"><span class="pre">CHPL_TASKS</span></code> environment variable to <code class="docutils literal"><span class="pre">muxed</span></code>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_TASKS</span><span class="o">=</span>muxed
</pre></div>
</div>
<p>This specifies that you wish to use the Cray-specific tasking
layer.</p>
</li>
<li><p class="first">Set your CHPL_COMM environment variable to <code class="docutils literal"><span class="pre">ugni</span></code> (the usual
default), <code class="docutils literal"><span class="pre">gasnet</span></code> (an alternative default), or <code class="docutils literal"><span class="pre">none</span></code>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_COMM</span><span class="o">=</span>ugni
</pre></div>
</div>
</li>
</ol>
<p>or:</p>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_COMM</span><span class="o">=</span>gasnet
</pre></div>
</div>
</div></blockquote>
<p>or:</p>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_COMM</span><span class="o">=</span>none
</pre></div>
</div>
<p>All three Chapel communication layers are known to work with muxed
tasking.  Other Chapel environment variables having to do with
runtime layers can be left unset.  Setting <code class="docutils literal"><span class="pre">CHPL_TASKS</span></code> and
<code class="docutils literal"><span class="pre">CHPL_COMM</span></code> like this will cause the correct combination of other
runtime layers that work with those to be selected automatically.</p>
</div></blockquote>
<p>There are a few special parameters recognized by the muxed tasking
layer:</p>
<div class="section" id="controlling-the-call-stack-size">
<h4><a class="toc-backref" href="#id14">Controlling the Call Stack Size</a><a class="headerlink" href="#controlling-the-call-stack-size" title="Permalink to this headline">¶</a></h4>
<p>For muxed tasking, more so than for other tasking implementations,
it may be important to reduce the task call stack size from its
default of 8 MiB.  A side effect of using the ugni communication
layer is that task stacks have to be created at full size.  With
other comm layers (or no comm layer), creating a stack just reserves
the memory for it without actually bringing the pages of memory into
existence.  The memory does not exist until each page of the stack
is actually used.  If the stack limit is 8 MiB (the default) and
2,000 tasks exist at the same time but each one only uses 32 KiB of
its stack space, then the program only requires about 64 MiB (2000 *
32 KiB) of memory for stacks.  But with ugni communications, the
network interactions require that all the space be brought into
existence up front.  So there, our hypothetical program would need
16 GiB (2000 * 8 MiB) of heap space just for stacks.  Thus with ugni
communications, in programs that may have many tasks active at once
but where each one does not need a very large call stack (such as
SSCA#2), it can be useful to make the stack size smaller than its
default of 8 MiB.</p>
<p>You can set the task stack size using <code class="docutils literal"><span class="pre">CHPL_RT_CALL_STACK_SIZE</span></code>, as described
in <a class="reference internal" href="../usingchapel/executing.html#readme-executing"><span>Executing Chapel Programs</span></a>.  The following would make the task stack
size 128 KiB, for example:</p>
<blockquote>
<div><div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_RT_CALL_STACK_SIZE</span><span class="o">=</span>128k
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="stack-overflow-checking">
<h4><a class="toc-backref" href="#id15">Stack Overflow Checking</a><a class="headerlink" href="#stack-overflow-checking" title="Permalink to this headline">¶</a></h4>
<p>With muxed tasking, the compiler <code class="docutils literal"><span class="pre">--stack-checks</span></code> setting
specifies the default setting for execution-time stack overflow
checking.  If this is set and the program heap (from which stacks
are allocated) is not on hugepages then each stack gets an
inaccessible guard page added at the end toward which stack growth
occurs.  If the stack overflows into this guard page, the resulting
SIGSEGV is diagnostic.  This signal-based solution is crude, but
also trustworthy because it relies on OS services.</p>
<p>Guard pages cannot be used when the heap is on hugepages, because
the system call that makes memory pages inaccessible cannot be
applied to hugepages.  Currently the heap is on hugepages when
<code class="docutils literal"><span class="pre">CHPL_COMM=ugni</span></code> and there is a craype-hugepages module loaded.
In this case muxed tasking does synchronous
stack overflow detection instead.  Explicit checks against the
task's stack limit are done on entry to selected functions in the
muxed tasking layer.  If overflow is seen, the runtime prints an
error message and halts the program.  The level of overflow checking
may be controlled using the <code class="docutils literal"><span class="pre">CHPL_RT_STACK_CHECK_LEVEL</span></code>
environment variable, which can take the following values:</p>
<blockquote>
<div><table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">0:</th><td class="field-body">no stack overflow checking</td>
</tr>
<tr class="field-even field"><th class="field-name">1:</th><td class="field-body">limited stack overflow checking (default)</td>
</tr>
<tr class="field-odd field"><th class="field-name">2:</th><td class="field-body">more stack overflow checking</td>
</tr>
</tbody>
</table>
</div></blockquote>
<p>Successively higher levels of overflow checking are more likely both to
catch overflow and to catch it earlier, but they also have more overhead
and thus a greater impact on performance.</p>
<p>Note: in some situations the check as to whether or not the task
stacks are in hugepage memory gets the wrong answer, leading to
internal errors when the tasking layer tries to use guard pages and
cannot do so.  This issue and its workarounds are tracked here:</p>
<blockquote>
<div><a class="reference external" href="https://chapel.atlassian.net/browse/CHAPEL-117">https://chapel.atlassian.net/browse/CHAPEL-117</a></div></blockquote>
</div>
<div class="section" id="number-of-threads-per-locale">
<h4><a class="toc-backref" href="#id16">Number of Threads per Locale</a><a class="headerlink" href="#number-of-threads-per-locale" title="Permalink to this headline">¶</a></h4>
<p>The muxed tasking layer gets the threads it uses as task execution
vehicles from the soft-threads threading layer.  The soft-threads
layer provides lightweight threads that can be switched rapidly.
Chapel configuration constants allow you to control how many
processor cores the soft-threads threading layer uses and the total
number of lightweight threads it provides to the tasking layer.</p>
<p>The <code class="docutils literal"><span class="pre">CHPL_RT_NUM_HARDWARE_THREADS</span></code> environment variable specifies the
number of cores that should be used to run Chapel tasks on each
locale.  The default is to use all of the cores, but if something
other than the ability to run tasks limits performance, such as
limited parallelism or doing many remote loads, reducing this may
improve performance.  You can set <code class="docutils literal"><span class="pre">CHPL_RT_NUM_HARDWARE_THREADS</span></code> to
any value from 1 to the actual number of hardware processor cores.
For applications where the performance is dominated by the latency
of small remote loads, such as the SSCA#2 benchmark and other graph
processing codes, using 8 processor cores often gives better
performance than using all of them.</p>
<p>The <code class="docutils literal"><span class="pre">CHPL_RT_NUM_THREADS_PER_LOCALE</span></code> environment variable specifies
the number of lightweight threads the soft-threads threading layer
should provide to the muxed tasking layer for hosting tasks.  The
default is the number of processor cores being used, which gives
good performance in most cases.  However, if performance is limited
by something other than on-node processor or bandwidth limits, and
especially for applications like RA or SSCA#2 where performance is
limited by network latency, it can be worthwhile to set this to as
much as 16*the number of hardware threads (whether default or user
specified).  You can set this to any value &gt;= 0, but note that the
soft-threads threading layer will silently limit it to &gt;= 1 and &lt;=
32*the number of hardware threads.</p>
</div>
</div>
</div>
<div class="section" id="network-atomics">
<h2><a class="toc-backref" href="#id17">Network Atomics</a><a class="headerlink" href="#network-atomics" title="Permalink to this headline">¶</a></h2>
<p>The Gemini(TM) and Aries(TM) networks support remote atomic memory
operations (AMOs) on XC, XE, and XK series systems.  When the <code class="docutils literal"><span class="pre">CHPL_COMM</span></code>
environment variable is set to <code class="docutils literal"><span class="pre">ugni</span></code>, the following operations on
remote atomics are done using the network:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>32- and 64-bit signed and unsigned integer types:
32- and 64-bit floating point types:
  read()
  write()
  exchange()
  compareExchange()
  add(), fetchAdd()
  sub(), fetchSub()

32- and 64-bit signed and unsigned integer types:
  or(),  fetchOr()
  and(), fetchAnd()
  xor(), fetchXor()
</pre></div>
</div>
<p>Note that on XE and XK systems, which have Gemini networks, out of the
above list only the 64-bit integer operations are done natively by the
network hardware.  32-bit integer and all floating point operations are
done using implicit <code class="docutils literal"><span class="pre">on</span></code> statements inside the ugni communication
layer, accelerated by Gemini hardware capabilities.</p>
<p>On XC systems, which have Aries networks, all of the operations shown
above are done natively by the network hardware.</p>
</div>
<div class="section" id="known-constraints-and-bugs">
<h2><a class="toc-backref" href="#id18">Known Constraints and Bugs</a><a class="headerlink" href="#known-constraints-and-bugs" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Our PBS launcher explicitly supports PBS Pro, Moab/Torque, and the
NCCS site versions of PBS.  It may also work with other versions.
If our PBS launcher does not work for you, you can fall back on a
more manual launch of your program.  For example:</p>
<ul class="simple">
<li>Launch the <code class="docutils literal"><span class="pre">a.out_real</span></code> binary manually using aprun and your own
qsub script or command.</li>
<li>Use <code class="docutils literal"><span class="pre">./a.out</span> <span class="pre">--generate-qsub-script</span></code> to generate a qsub script.
Then edit the generated script and launch the <code class="docutils literal"><span class="pre">a.out_real</span></code> binary
manually as above.</li>
</ul>
</li>
<li><p class="first">Redirecting stdin when executing a Chapel program under PBS/qsub
may not work due to limitations of qsub.</p>
</li>
<li><p class="first">GASNet targets multiple network <em>conduits</em> as the underlying
communication mechanism.  On certain platforms, the Chapel build
will use the <code class="docutils literal"><span class="pre">mpi</span></code> conduit as the default.  As a result of using the
mpi conduit, you may see a GASNet warning message at program start
up.  To squelch this message, you can set the environment variable
<code class="docutils literal"><span class="pre">GASNET_QUIET=yes</span></code>.</p>
</li>
<li><p class="first">There is a known GASNet build issue when using the gemini or aries
conduits with hugepage support that results in link errors due to
multiply defined symbols in the hugetlbfs library.  The workaround
is to make sure that you do not have any <code class="docutils literal"><span class="pre">craype-hugepages*</span></code> module
loaded when you compile and link a Chapel program while using the
GASNet communication layer.  You may load a hugepage module when
running the Chapel program.</p>
</li>
<li><p class="first">For X-series systems, there is a known issue with the Cray MPI
release that causes some programs to assert and then hang during
exit.  A workaround is to set the environment variable,
<code class="docutils literal"><span class="pre">MPICH_GNI_DYNAMIC_CONN</span></code> to <code class="docutils literal"><span class="pre">disabled</span></code>.  Setting this environment
variable affects all MPI programs, so remember to unset it after
running your Chapel program.</p>
</li>
<li><p class="first">The amount of memory available to a Chapel program running over
GASNet with the gemini and aries conduits is allocated at program
start up.  The default memory segment size may be too high on some
platforms, resulting in an internal Chapel error or a GASNet
initialization error such as:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>node 1 log gasnetc_init_segment() at $CHPL_HOME/third-party/gasnet/gasnet-src/gemini-conduit/gasnet_gemini.c:&lt;line#&gt;: MemRegister segment fault 8 at  0x2aab6ae00000 60000000, code GNI_RC_ERROR_RESOURCE
</pre></div>
</div>
<p>If your Chapel program exits with such an error, try setting the
environment variable <code class="docutils literal"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code> or <code class="docutils literal"><span class="pre">GASNET_MAX_SEGSIZE</span></code> to a
lower value than the default (say 1G) and re-running your program.
For more information, refer to the discussion of <code class="docutils literal"><span class="pre">CHPL_RT_MAX_HEAP_SIZE</span></code>
above and/or the discussion of <code class="docutils literal"><span class="pre">GASNET_MAX_SEGSIZE</span></code> here:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span>$CHPL_HOME/third-party/gasnet/gasnet-src/README
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="nccs-user-notes">
<h2><a class="toc-backref" href="#id19">NCCS user notes</a><a class="headerlink" href="#nccs-user-notes" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">NCCS Cray systems use a different qsub mechanism in order to
enforce their queuing policies.  We have attempted to make our
pbs-aprun launch code work with this version of qsub, but require a
<code class="docutils literal"><span class="pre">CHPL_LAUNCHER_ACCOUNT</span></code> environment variable to be set to specify your
NCCS account name.  For example:</p>
<div class="highlight-sh"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">CHPL_LAUNCHER_ACCOUNT</span><span class="o">=</span>MYACCOUNTID
</pre></div>
</div>
</li>
<li><p class="first">NCCS users either need to specify <code class="docutils literal"><span class="pre">debug</span></code> as their queue or set an
explicit wall clock time limit using the mechanisms described above.</p>
</li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cygwin.html" class="btn btn-neutral float-right" title="Using Chapel on Cygwin" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="index.html" class="btn btn-neutral" title="Platform-Specific Notes" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Cray Inc.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.14.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
 



</body>
</html>