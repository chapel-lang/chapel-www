<!DOCTYPE html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
<meta name="robots" content="all,follow">
<meta name="googlebot" content="index,follow,snippet,archive">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>GPU Programming Made Simple with Chapel</title>
<meta name="author" content="" />




<meta name="keywords" content="TODO">


<meta name="description" content="Writing GPU programs is a breeze with the Chapel programming language">

<meta name="generator" content="Hugo 0.145.0">


<link href='../css/roboto.css' rel='stylesheet' type='text/css'>


<link rel="stylesheet" href="../css/bootstrap.min.css">


<link href="../css/animate.css" rel="stylesheet">



  <link href="../css/style.default.css" rel="stylesheet" id="theme-stylesheet">



<link href="../css/custom.css" rel="stylesheet">



  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->



<link rel="shortcut icon" href="../img/favicon.ico" type="image/x-icon" />
<link rel="apple-touch-icon" href="../img/apple-touch-icon.png" />


<link href="../css/owl.carousel.css" rel="stylesheet">
<link href="../css/owl.theme.css" rel="stylesheet">


<link rel="alternate" href="../index.xml" type="application/rss+xml" title="The Chapel Programming Language">











<meta name="twitter:card" content="summary">

<meta name="twitter:title" content="GPU Programming Made Simple with Chapel">

<meta name="twitter:description" content="Writing GPU programs is a breeze with the Chapel programming language">


    
  </head>

  <body>

    <div id="all">

        <header class="navbar-affixed-top" data-offset-top="62">
    <div class="navbar navbar-default yamm mouseover" role="navigation" id="navbar">
        <div class="container">
            <div class="navbar-header">
                <a class="navbar-brand home" href="../">
                    
                      <img src="../img/chapel-logo.svg" alt="GPU Programming Made Simple with Chapel logo" class="hidden-xl hidden-lg" />
                      <img src="../img/chapel-logo.svg" alt="GPU Programming Made Simple with Chapel logo" class="visible-xl visible-lg" />
                    
                    <span class="sr-only">GPU Programming Made Simple with Chapel - go to homepage</span>
                </a>
                <div class="navbar-buttons">
                    <button type="button" class="navbar-toggle btn-template-main" data-toggle="collapse" data-target="#navigation">
                      <span class="sr-only">Toggle Navigation</span>
                        <img class="hamburger" src=../img/hamburger-button.png>
                    </button>
                </div>
            </div>
            

            <div class="navbar-collapse collapse" id="navigation">
                <ul class="nav navbar-nav navbar-right">
                  

                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="../download">Download</a>
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                    
                    
                    <li class="dropdown ">
                        <a href="https://chapel-lang.org/docs" class="dropdown-hover" data-hover="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Docs <span class="caret"></span></a>
                        
                        <ul class="dropdown-menu">
                            
                            <li><a href="https://chapel-lang.org/docs/usingchapel/QUICKSTART.html">Quickstart Instructions</a></li>
                            
                            <li><a href="https://chapel-lang.org/docs/language/spec/">Language Spec</a></li>
                            
                            <li><a href="https://chapel-lang.org/docs/primers/">Primers</a></li>
                            
                            <li><a href="https://chapel-lang.org/docs/modules/standard.html">Modules</a></li>
                            
                            <li><a href="https://chapel-lang.org/docs/developer/">Developer/Contributor Docs</a></li>
                            
                            <li><a href="https://chapel-lang.org/docs/technotes/">Technical Notes</a></li>
                            
                        </ul>
                        
                    </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="../learn">Learn</a>
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                    
                    
                    <li class="dropdown ">
                        <a href="../resources" class="dropdown-hover" data-hover="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Resources <span class="caret"></span></a>
                        
                        <ul class="dropdown-menu">
                            
                            <li><a href="../tutorials">Tutorials</a></li>
                            
                            <li><a href="../papers">Papers</a></li>
                            
                            <li><a href="../presentations">Presentations</a></li>
                            
                            <li><a href="../examples">Examples</a></li>
                            
                        </ul>
                        
                    </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="../community">Community</a>
                  </li>
                  
                  
                  
                  

                  

                  

                  

                  
                  <li class="dropdown ">
                    <a href="../blog">Blog</a>
                  </li>
                  
                  
                </ul>
            </div>
            

            <div class="collapse clearfix" id="search">
                <form class="navbar-form" role="search">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Search">
                        <span class="input-group-btn">
                    <button type="submit" class="btn btn-template-main"><i class="fas fa-search"></i></button>
                </span>
                    </div>
                </form>
            </div>
            
        </div>
    </div>
</header>




        <div id="heading-breadcrumbs">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h1>GPU Programming Made Simple with Chapel</h1>
            </div>
        </div>
    </div>
</div>


        <div id="content">
            

            <div class="container">

                <div class="row">

                    <div class="col-md-12">

                        <div>
                          <p class="content-paragraph">GPUs are the powerhouse of modern computing systems. Chapel&rsquo;s general-purpose capabilities for parallelism and locality control makes GPU programming as easy as programming a multi-core CPU. These capabilities makes GPU programming intuitive on a laptop with a GPU, on a leadership-class supercomputer, or anything in between. Chapel supports programming NVIDIA and AMD GPUs in a vendor-neutral way; the same code can be used on GPUs from both vendors without any change.</p>
<h1 id="example-matrix-multiplication">Example: Matrix Multiplication</h1>



<section id="test">
  <div class="container">
    <div class="col-md-6 col-0 col-even">
      <div class="comparison-block" id="code-comparison1">
        <fieldset>
          
            <div class="sample-wrapper-div">
              <label class="radio-code-selector" for="radio1-Chapel CPU">
                <input type="radio" id="radio1-Chapel CPU" value="Chapel CPU" name="code-sample1" checked>
                Chapel CPU
              </label>
            </div>
          
            <div class="sample-wrapper-div">
              <label class="radio-code-selector" for="radio1-Chapel GPU">
                <input type="radio" id="radio1-Chapel GPU" value="Chapel GPU" name="code-sample1" >
                Chapel GPU
              </label>
            </div>
          
            <div class="sample-wrapper-div">
              <label class="radio-code-selector" for="radio1-CUDA">
                <input type="radio" id="radio1-CUDA" value="CUDA" name="code-sample1" >
                CUDA
              </label>
            </div>
          
            <div class="sample-wrapper-div">
              <label class="radio-code-selector" for="radio1-OpenCL">
                <input type="radio" id="radio1-OpenCL" value="OpenCL" name="code-sample1" >
                OpenCL
              </label>
            </div>
          
        </fieldset>

        
          
          <div class="code-comparison code-sample1" data-for-sample="Chapel CPU"><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Chapel" data-lang="Chapel"><span style="display:flex;"><span><span style="color:#cf222e">config</span><span style="color:#fff"> </span><span style="color:#cf222e">const</span><span style="color:#fff"> </span><span style="color:#1f2328">N</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">2000</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#1f2328">M</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">3000</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#1f2328">P</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">4000</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">A</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">N</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">B</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">P</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">C</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">N</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">P</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">forall</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#1f2328">C</span><span style="color:#1f2328">.</span><span style="color:#cf222e">domain</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">j</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">C</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">+=</span><span style="color:#fff"> </span><span style="color:#1f2328">A</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">j</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#1f2328">B</span><span style="color:#1f2328">[</span><span style="color:#1f2328">j</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">];</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span></code></pre></div></div>
        
          
          <div class="code-comparison code-sample1" data-for-sample="Chapel GPU"><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Chapel" data-lang="Chapel"><span style="display:flex;"><span><span style="color:#cf222e">config</span><span style="color:#fff"> </span><span style="color:#cf222e">const</span><span style="color:#fff"> </span><span style="color:#1f2328">N</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">2000</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#1f2328">M</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">3000</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#1f2328">P</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">4000</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">hostA</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">N</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">hostB</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">P</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">hostC</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">N</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">P</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">on</span><span style="color:#fff"> </span><span style="color:#1f2328">here</span><span style="color:#1f2328">.</span><span style="color:#1f2328">gpus</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">devA</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">hostA</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span><span style="color:#57606a">// allocate on GPU
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">  </span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">devB</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">hostB</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span><span style="color:#57606a">// and copy from host to device
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">  </span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">devC</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">hostC</span><span style="color:#1f2328">.</span><span style="color:#cf222e">type</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">forall</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#1f2328">devC</span><span style="color:#1f2328">.</span><span style="color:#cf222e">domain</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">j</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#1f2328">devC</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">+=</span><span style="color:#fff"> </span><span style="color:#1f2328">devA</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">j</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#1f2328">devB</span><span style="color:#1f2328">[</span><span style="color:#1f2328">j</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">];</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#1f2328">hostC</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">devC</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span><span style="color:#57606a">// copy from device to host
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#1f2328">}</span></span></span></code></pre></div></div>
        
          
          <div class="code-comparison code-sample1" data-for-sample="CUDA"><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#57606a">#include</span> <span style="color:#57606a">&lt;cuda_runtime.h&gt;</span><span style="color:#57606a">
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#include</span> <span style="color:#57606a">&lt;iostream&gt;</span><span style="color:#57606a">
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">inline</span> <span style="color:#cf222e">void</span> <span style="color:#6639ba">__checkCudaError</span><span style="color:#1f2328">(</span>cudaError_t err<span style="color:#1f2328">,</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> file<span style="color:#1f2328">,</span> <span style="color:#cf222e">int</span> line<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>err <span style="color:#0550ae">!=</span> cudaSuccess<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        fprintf<span style="color:#1f2328">(</span>stderr<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;CUDA error at %s:%d: %s</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span> file<span style="color:#1f2328">,</span> line<span style="color:#1f2328">,</span> cudaGetErrorString<span style="color:#1f2328">(</span>err<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>        exit<span style="color:#1f2328">(</span>EXIT_FAILURE<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#define checkCudaError(call) __checkCudaError((call), __FILE__, __LINE__)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span>__global__ <span style="color:#cf222e">void</span> <span style="color:#6639ba">matrixMultiplyKernel</span><span style="color:#1f2328">(</span><span style="color:#cf222e">const</span> <span style="color:#cf222e">double</span><span style="color:#0550ae">*</span> A<span style="color:#1f2328">,</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">double</span><span style="color:#0550ae">*</span> B<span style="color:#1f2328">,</span> <span style="color:#cf222e">double</span><span style="color:#0550ae">*</span> C<span style="color:#1f2328">,</span> <span style="color:#cf222e">int</span> N<span style="color:#1f2328">,</span> <span style="color:#cf222e">int</span> M<span style="color:#1f2328">,</span> <span style="color:#cf222e">int</span> P<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">int</span> i <span style="color:#0550ae">=</span> blockIdx<span style="color:#1f2328">.</span>y <span style="color:#0550ae">*</span> blockDim<span style="color:#1f2328">.</span>y <span style="color:#0550ae">+</span> threadIdx<span style="color:#1f2328">.</span>y<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">int</span> k <span style="color:#0550ae">=</span> blockIdx<span style="color:#1f2328">.</span>x <span style="color:#0550ae">*</span> blockDim<span style="color:#1f2328">.</span>x <span style="color:#0550ae">+</span> threadIdx<span style="color:#1f2328">.</span>x<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>i <span style="color:#0550ae">&lt;</span> N <span style="color:#0550ae">&amp;&amp;</span> k <span style="color:#0550ae">&lt;</span> P<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">double</span> sum <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.0f</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">int</span> j <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> j <span style="color:#0550ae">&lt;</span> M<span style="color:#1f2328">;</span> <span style="color:#0550ae">++</span>j<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            sum <span style="color:#0550ae">+=</span> A<span style="color:#1f2328">[</span>i <span style="color:#0550ae">*</span> M <span style="color:#0550ae">+</span> j<span style="color:#1f2328">]</span> <span style="color:#0550ae">*</span> B<span style="color:#1f2328">[</span>j <span style="color:#0550ae">*</span> P <span style="color:#0550ae">+</span> k<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        C<span style="color:#1f2328">[</span>i <span style="color:#0550ae">*</span> P <span style="color:#0550ae">+</span> k<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> sum<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">int</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Matrix sizes
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">int</span> N <span style="color:#0550ae">=</span> <span style="color:#0550ae">2000</span><span style="color:#1f2328">,</span> M <span style="color:#0550ae">=</span> <span style="color:#0550ae">3000</span><span style="color:#1f2328">,</span> P <span style="color:#0550ae">=</span> <span style="color:#0550ae">4000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">double</span> <span style="color:#0550ae">*</span>hostA<span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span>hostB<span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span>hostC<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">double</span> <span style="color:#0550ae">*</span>devA<span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span>devB<span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span>devC<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Allocate host memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    hostA <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>N <span style="color:#0550ae">*</span> M <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    hostB <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>M <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    hostC <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>N <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Verify that allocations succeeded
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>hostA <span style="color:#0550ae">==</span> <span style="color:#6639ba">NULL</span> <span style="color:#0550ae">||</span> hostB <span style="color:#0550ae">==</span> <span style="color:#6639ba">NULL</span> <span style="color:#0550ae">||</span> hostC <span style="color:#0550ae">==</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>      fprintf<span style="color:#1f2328">(</span>stderr<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Failed to allocate host vectors!</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>      exit<span style="color:#1f2328">(</span>EXIT_FAILURE<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Data initialization omitted
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Allocate device memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    checkCudaError<span style="color:#1f2328">(</span>cudaMalloc<span style="color:#1f2328">((</span><span style="color:#cf222e">void</span><span style="color:#0550ae">**</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>devA<span style="color:#1f2328">,</span> N <span style="color:#0550ae">*</span> M <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">)));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaMalloc<span style="color:#1f2328">((</span><span style="color:#cf222e">void</span><span style="color:#0550ae">**</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>devB<span style="color:#1f2328">,</span> M <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">)));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaMalloc<span style="color:#1f2328">((</span><span style="color:#cf222e">void</span><span style="color:#0550ae">**</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>devC<span style="color:#1f2328">,</span> N <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">)));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Copy matrices from host to device
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    checkCudaError<span style="color:#1f2328">(</span>cudaMemcpy<span style="color:#1f2328">(</span>devA<span style="color:#1f2328">,</span> hostA<span style="color:#1f2328">,</span> N <span style="color:#0550ae">*</span> M <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">),</span> cudaMemcpyHostToDevice<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaMemcpy<span style="color:#1f2328">(</span>devB<span style="color:#1f2328">,</span> hostB<span style="color:#1f2328">,</span> M <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">),</span> cudaMemcpyHostToDevice<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Define block and grid sizes
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    dim3 blockDim<span style="color:#1f2328">(</span><span style="color:#0550ae">16</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">16</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    dim3 gridDim<span style="color:#1f2328">((</span>P <span style="color:#0550ae">+</span> blockDim<span style="color:#1f2328">.</span>x <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">/</span> blockDim<span style="color:#1f2328">.</span>x<span style="color:#1f2328">,</span> <span style="color:#1f2328">(</span>N <span style="color:#0550ae">+</span> blockDim<span style="color:#1f2328">.</span>y <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">/</span> blockDim<span style="color:#1f2328">.</span>y<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Launch the kernel
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    matrixMultiplyKernel<span style="color:#0550ae">&lt;&lt;&lt;</span>gridDim<span style="color:#1f2328">,</span> blockDim<span style="color:#0550ae">&gt;&gt;&gt;</span><span style="color:#1f2328">(</span>devA<span style="color:#1f2328">,</span> devB<span style="color:#1f2328">,</span> devC<span style="color:#1f2328">,</span> N<span style="color:#1f2328">,</span> M<span style="color:#1f2328">,</span> P<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaPeekAtLastError<span style="color:#1f2328">());</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaDeviceSynchronize<span style="color:#1f2328">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Copy result matrix from device to host
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    checkCudaError<span style="color:#1f2328">(</span>cudaMemcpy<span style="color:#1f2328">(</span>hostC<span style="color:#1f2328">,</span> devC<span style="color:#1f2328">,</span> N <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">),</span> cudaMemcpyDeviceToHost<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Free device memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    checkCudaError<span style="color:#1f2328">(</span>cudaFree<span style="color:#1f2328">(</span>devA<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaFree<span style="color:#1f2328">(</span>devB<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaFree<span style="color:#1f2328">(</span>devC<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Free host memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    free<span style="color:#1f2328">(</span>hostA<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    free<span style="color:#1f2328">(</span>hostB<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    free<span style="color:#1f2328">(</span>hostC<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div></div>
        
          
          <div class="code-comparison code-sample1" data-for-sample="OpenCL"><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#57606a">/* Implementation based on https://cnugteren.github.io/tutorial/pages/page3.html
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">   This kernel appears in a different file from main */</span>
</span></span><span style="display:flex;"><span>__kernel <span style="color:#cf222e">void</span> <span style="color:#6639ba">myGEMM1</span><span style="color:#1f2328">(</span><span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> M<span style="color:#1f2328">,</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> N<span style="color:#1f2328">,</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> P<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#cf222e">const</span> __global <span style="color:#cf222e">float</span><span style="color:#0550ae">*</span> A<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#cf222e">const</span> __global <span style="color:#cf222e">float</span><span style="color:#0550ae">*</span> B<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                      __global <span style="color:#cf222e">float</span><span style="color:#0550ae">*</span> C<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Thread identifiers
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> globalRow <span style="color:#0550ae">=</span> get_global_id<span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">);</span> <span style="color:#57606a">// Row ID of C (0..M)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> globalCol <span style="color:#0550ae">=</span> get_global_id<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">);</span> <span style="color:#57606a">// Col ID of C (0..N)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Compute a single element (loop over K)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">float</span> acc <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.0f</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">int</span> k<span style="color:#0550ae">=</span><span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> k<span style="color:#0550ae">&lt;</span>P<span style="color:#1f2328">;</span> k<span style="color:#0550ae">++</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        acc <span style="color:#0550ae">+=</span> A<span style="color:#1f2328">[</span>k<span style="color:#0550ae">*</span>M <span style="color:#0550ae">+</span> globalRow<span style="color:#1f2328">]</span> <span style="color:#0550ae">*</span> B<span style="color:#1f2328">[</span>globalCol<span style="color:#0550ae">*</span>P <span style="color:#0550ae">+</span> k<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Store the result
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    C<span style="color:#1f2328">[</span>globalCol<span style="color:#0550ae">*</span>M <span style="color:#0550ae">+</span> globalRow<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> acc<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">void</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Define the matrix dimensions
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> M <span style="color:#0550ae">=</span> <span style="color:#0550ae">2000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> N <span style="color:#0550ae">=</span> <span style="color:#0550ae">3000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> P <span style="color:#0550ae">=</span> <span style="color:#0550ae">4000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Define OpenCL variables
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  cl_int err<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_platform_id platform <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_device_id device <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_device_id devices<span style="color:#1f2328">[</span>MAX_NUM_DEVICES<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>  cl_uint numDevices <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_context_properties props<span style="color:#1f2328">[</span><span style="color:#0550ae">3</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>CL_CONTEXT_PLATFORM<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>  cl_context context <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_command_queue queue <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_event event <span style="color:#0550ae">=</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_program program <span style="color:#0550ae">=</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span> deviceName<span style="color:#1f2328">[</span>MAX_DEVICE_NAME<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Configure the OpenCL environment
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clGetPlatformIDs<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>platform<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetDeviceIDs<span style="color:#1f2328">(</span>platform<span style="color:#1f2328">,</span> CL_DEVICE_TYPE_GPU<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>numDevices<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetDeviceIDs<span style="color:#1f2328">(</span>platform<span style="color:#1f2328">,</span> CL_DEVICE_TYPE_GPU<span style="color:#1f2328">,</span> numDevices<span style="color:#1f2328">,</span> devices<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  device <span style="color:#0550ae">=</span> devices<span style="color:#1f2328">[</span>CURRENT_DEVICE<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>  props<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span>cl_context_properties<span style="color:#1f2328">)</span>platform<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  context <span style="color:#0550ae">=</span> clCreateContext<span style="color:#1f2328">(</span>props<span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>device<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  queue <span style="color:#0550ae">=</span> clCreateCommandQueue<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> device<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetDeviceInfo<span style="color:#1f2328">(</span>device<span style="color:#1f2328">,</span> CL_DEVICE_NAME<span style="color:#1f2328">,</span> MAX_DEVICE_NAME<span style="color:#1f2328">,</span> deviceName<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Read the kernel file from disk
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  <span style="color:#cf222e">long</span> sizeHeader<span style="color:#1f2328">,</span> sizeSource<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> header <span style="color:#0550ae">=</span> readKernelFile<span style="color:#1f2328">(</span>CL_INCLUDE_FILE<span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>sizeHeader<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> source <span style="color:#0550ae">=</span> readKernelFile<span style="color:#1f2328">(</span>CL_KERNEL_FILE<span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>sizeSource<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">long</span> size <span style="color:#0550ae">=</span> <span style="color:#0550ae">2</span> <span style="color:#0550ae">+</span> sizeHeader <span style="color:#0550ae">+</span> sizeSource<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> code <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>size<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">for</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">int</span> c<span style="color:#0550ae">=</span><span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> c<span style="color:#0550ae">&lt;</span>size<span style="color:#1f2328">;</span> c<span style="color:#0550ae">++</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span> code<span style="color:#1f2328">[</span>c<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;\0&#39;</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>  strcat<span style="color:#1f2328">(</span>code<span style="color:#1f2328">,</span> header<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  strcat<span style="color:#1f2328">(</span>code<span style="color:#1f2328">,</span> source<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">const</span> <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> constCode <span style="color:#0550ae">=</span> code<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  free<span style="color:#1f2328">(</span>header<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  free<span style="color:#1f2328">(</span>source<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Compile the kernel file
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  program <span style="color:#0550ae">=</span> clCreateProgramWithSource<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>constCode<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clBuildProgram<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> COMPILER_OPTIONS<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Check for compilation errors
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  size_t logSize<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetProgramBuildInfo<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> device<span style="color:#1f2328">,</span> CL_PROGRAM_BUILD_LOG<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>logSize<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> messages <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">((</span><span style="color:#0550ae">1</span><span style="color:#0550ae">+</span>logSize<span style="color:#1f2328">)</span><span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetProgramBuildInfo<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> device<span style="color:#1f2328">,</span> CL_PROGRAM_BUILD_LOG<span style="color:#1f2328">,</span> logSize<span style="color:#1f2328">,</span> messages<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  messages<span style="color:#1f2328">[</span>logSize<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;\0&#39;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">//if (logSize &gt; 10) { printf(&#34;## Compiler message: %s\n&#34;, messages); }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  free<span style="color:#1f2328">(</span>messages<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Retrieve the PTX code from the OpenCL compiler and output it to disk
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  size_t binSize<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetProgramInfo<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> CL_PROGRAM_BINARY_SIZES<span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span>size_t<span style="color:#1f2328">),</span> <span style="color:#0550ae">&amp;</span>binSize<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">unsigned</span> <span style="color:#cf222e">char</span> <span style="color:#0550ae">*</span>bin <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">unsigned</span> <span style="color:#cf222e">char</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>binSize<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetProgramInfo<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> CL_PROGRAM_BINARIES<span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">unsigned</span> <span style="color:#cf222e">char</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">),</span> <span style="color:#0550ae">&amp;</span>bin<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  FILE<span style="color:#0550ae">*</span> file <span style="color:#0550ae">=</span> fopen<span style="color:#1f2328">(</span>CL_PTX_FILE<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;wb&#34;</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  fwrite<span style="color:#1f2328">(</span>bin<span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#1f2328">),</span> binSize<span style="color:#1f2328">,</span> file<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  fclose<span style="color:#1f2328">(</span>file<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  free<span style="color:#1f2328">(</span>bin<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Prepare OpenCL memory objects
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  cl_mem bufA    <span style="color:#0550ae">=</span> clCreateBuffer<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> CL_MEM_READ_ONLY<span style="color:#1f2328">,</span>  M<span style="color:#0550ae">*</span>P<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>A<span style="color:#1f2328">),</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  cl_mem bufB    <span style="color:#0550ae">=</span> clCreateBuffer<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> CL_MEM_READ_ONLY<span style="color:#1f2328">,</span>  P<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>B<span style="color:#1f2328">),</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  cl_mem bufB_TR <span style="color:#0550ae">=</span> clCreateBuffer<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> CL_MEM_READ_ONLY<span style="color:#1f2328">,</span>  N<span style="color:#0550ae">*</span>P<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>B<span style="color:#1f2328">),</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  cl_mem bufC    <span style="color:#0550ae">=</span> clCreateBuffer<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> CL_MEM_READ_WRITE<span style="color:#1f2328">,</span> M<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>C<span style="color:#1f2328">),</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Copy matrices to the GPU (also C to erase the results of the previous run)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clEnqueueWriteBuffer<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> bufA<span style="color:#1f2328">,</span> CL_TRUE<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> M<span style="color:#0550ae">*</span>P<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>A<span style="color:#1f2328">),</span> A<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clEnqueueWriteBuffer<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> bufB<span style="color:#1f2328">,</span> CL_TRUE<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> P<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>B<span style="color:#1f2328">),</span> B<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clEnqueueWriteBuffer<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> bufC<span style="color:#1f2328">,</span> CL_TRUE<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> M<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>C<span style="color:#1f2328">),</span> C<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Configure the myGEMM kernel
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  <span style="color:#cf222e">char</span> kernelname<span style="color:#1f2328">[</span><span style="color:#0550ae">100</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;myGEMM1&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_kernel kernel1 <span style="color:#0550ae">=</span> clCreateKernel<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> kernelname<span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Set the kernel arguments
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>M<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>N<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>P<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">3</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span>cl_mem<span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>bufA<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">4</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span>cl_mem<span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>bufB<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">5</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span>cl_mem<span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>bufC<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Configure the thread/work-group dimensions of the myGEMM kernel
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  <span style="color:#cf222e">const</span> size_t local<span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span> TS<span style="color:#1f2328">,</span> TS <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">const</span> size_t global<span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span> <span style="color:#1f2328">(</span>size_t<span style="color:#1f2328">)</span>M<span style="color:#1f2328">,</span> <span style="color:#1f2328">(</span>size_t<span style="color:#1f2328">)</span>N <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Run the myGEMM kernel
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clEnqueueNDRangeKernel<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> global<span style="color:#1f2328">,</span> local<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>event<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Copy the output matrix C back to the CPU memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clEnqueueReadBuffer<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> bufC<span style="color:#1f2328">,</span> CL_TRUE<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> M<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>C<span style="color:#1f2328">),</span> C<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Free the memory objects
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  free<span style="color:#1f2328">(</span>code<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufA<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufB<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufB_TR<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufC<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufA_XL<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufB_TR_XL<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufC_XL<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Clean-up OpenCL 
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  clReleaseCommandQueue<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseContext<span style="color:#1f2328">(</span>context<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseProgram<span style="color:#1f2328">(</span>program<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseKernel<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span></code></pre></div></div>
        
      </div>
    </div>
    <div class="col-md-6 col-0 col-even">
      <div class="comparison-block" id="code-comparison2">
        <fieldset>
          
            <div class="sample-wrapper-div">
              <label class="radio-code-selector" for="radio2-Chapel CPU">
                <input type="radio" id="radio2-Chapel CPU" value="Chapel CPU" name="code-sample" >
                Chapel CPU
              </label>
            </div>
          
            <div class="sample-wrapper-div">
              <label class="radio-code-selector" for="radio2-Chapel GPU">
                <input type="radio" id="radio2-Chapel GPU" value="Chapel GPU" name="code-sample" checked>
                Chapel GPU
              </label>
            </div>
          
            <div class="sample-wrapper-div">
              <label class="radio-code-selector" for="radio2-CUDA">
                <input type="radio" id="radio2-CUDA" value="CUDA" name="code-sample" >
                CUDA
              </label>
            </div>
          
            <div class="sample-wrapper-div">
              <label class="radio-code-selector" for="radio2-OpenCL">
                <input type="radio" id="radio2-OpenCL" value="OpenCL" name="code-sample" >
                OpenCL
              </label>
            </div>
          
        </fieldset>

        
          
          <div class="code-comparison code-sample2" data-for-sample="Chapel CPU"><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Chapel" data-lang="Chapel"><span style="display:flex;"><span><span style="color:#cf222e">config</span><span style="color:#fff"> </span><span style="color:#cf222e">const</span><span style="color:#fff"> </span><span style="color:#1f2328">N</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">2000</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#1f2328">M</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">3000</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#1f2328">P</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">4000</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">A</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">N</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">B</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">P</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">C</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">N</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">P</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">forall</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#1f2328">C</span><span style="color:#1f2328">.</span><span style="color:#cf222e">domain</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">j</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">C</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">+=</span><span style="color:#fff"> </span><span style="color:#1f2328">A</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">j</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#1f2328">B</span><span style="color:#1f2328">[</span><span style="color:#1f2328">j</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">];</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span></code></pre></div></div>
        
          
          <div class="code-comparison code-sample2" data-for-sample="Chapel GPU"><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Chapel" data-lang="Chapel"><span style="display:flex;"><span><span style="color:#cf222e">config</span><span style="color:#fff"> </span><span style="color:#cf222e">const</span><span style="color:#fff"> </span><span style="color:#1f2328">N</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">2000</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#1f2328">M</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">3000</span><span style="color:#1f2328">,</span><span style="color:#fff"> </span><span style="color:#1f2328">P</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">4000</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">hostA</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">N</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">hostB</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">P</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">hostC</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">N</span><span style="color:#1f2328">,</span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">P</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#cf222e">real</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#0550ae">1.0</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff"></span><span style="color:#cf222e">on</span><span style="color:#fff"> </span><span style="color:#1f2328">here</span><span style="color:#1f2328">.</span><span style="color:#1f2328">gpus</span><span style="color:#1f2328">[</span><span style="color:#0550ae">0</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">devA</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">hostA</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span><span style="color:#57606a">// allocate on GPU
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">  </span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">devB</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">hostB</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span><span style="color:#57606a">// and copy from host to device
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#fff">  </span><span style="color:#cf222e">var</span><span style="color:#fff"> </span><span style="color:#1f2328">devC</span><span style="color:#1f2328">:</span><span style="color:#fff"> </span><span style="color:#1f2328">hostC</span><span style="color:#1f2328">.</span><span style="color:#cf222e">type</span><span style="color:#1f2328">;</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#cf222e">forall</span><span style="color:#fff"> </span><span style="color:#1f2328">(</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">)</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#1f2328">devC</span><span style="color:#1f2328">.</span><span style="color:#cf222e">domain</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#cf222e">for</span><span style="color:#fff"> </span><span style="color:#1f2328">j</span><span style="color:#fff"> </span><span style="color:#cf222e">in</span><span style="color:#fff"> </span><span style="color:#0550ae">1</span><span style="color:#0550ae">..</span><span style="color:#1f2328">M</span><span style="color:#fff"> </span><span style="color:#1f2328">{</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">      </span><span style="color:#1f2328">devC</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">+=</span><span style="color:#fff"> </span><span style="color:#1f2328">devA</span><span style="color:#1f2328">[</span><span style="color:#1f2328">i</span><span style="color:#1f2328">,</span><span style="color:#1f2328">j</span><span style="color:#1f2328">]</span><span style="color:#fff"> </span><span style="color:#0550ae">*</span><span style="color:#fff"> </span><span style="color:#1f2328">devB</span><span style="color:#1f2328">[</span><span style="color:#1f2328">j</span><span style="color:#1f2328">,</span><span style="color:#1f2328">k</span><span style="color:#1f2328">];</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">    </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#1f2328">}</span><span style="color:#fff">
</span></span></span><span style="display:flex;"><span><span style="color:#fff">  </span><span style="color:#1f2328">hostC</span><span style="color:#fff"> </span><span style="color:#0550ae">=</span><span style="color:#fff"> </span><span style="color:#1f2328">devC</span><span style="color:#1f2328">;</span><span style="color:#fff"> </span><span style="color:#57606a">// copy from device to host
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#1f2328">}</span></span></span></code></pre></div></div>
        
          
          <div class="code-comparison code-sample2" data-for-sample="CUDA"><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#57606a">#include</span> <span style="color:#57606a">&lt;cuda_runtime.h&gt;</span><span style="color:#57606a">
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">#include</span> <span style="color:#57606a">&lt;iostream&gt;</span><span style="color:#57606a">
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">inline</span> <span style="color:#cf222e">void</span> <span style="color:#6639ba">__checkCudaError</span><span style="color:#1f2328">(</span>cudaError_t err<span style="color:#1f2328">,</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> file<span style="color:#1f2328">,</span> <span style="color:#cf222e">int</span> line<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>err <span style="color:#0550ae">!=</span> cudaSuccess<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        fprintf<span style="color:#1f2328">(</span>stderr<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;CUDA error at %s:%d: %s</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">,</span> file<span style="color:#1f2328">,</span> line<span style="color:#1f2328">,</span> cudaGetErrorString<span style="color:#1f2328">(</span>err<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>        exit<span style="color:#1f2328">(</span>EXIT_FAILURE<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#57606a">#define checkCudaError(call) __checkCudaError((call), __FILE__, __LINE__)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span>__global__ <span style="color:#cf222e">void</span> <span style="color:#6639ba">matrixMultiplyKernel</span><span style="color:#1f2328">(</span><span style="color:#cf222e">const</span> <span style="color:#cf222e">double</span><span style="color:#0550ae">*</span> A<span style="color:#1f2328">,</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">double</span><span style="color:#0550ae">*</span> B<span style="color:#1f2328">,</span> <span style="color:#cf222e">double</span><span style="color:#0550ae">*</span> C<span style="color:#1f2328">,</span> <span style="color:#cf222e">int</span> N<span style="color:#1f2328">,</span> <span style="color:#cf222e">int</span> M<span style="color:#1f2328">,</span> <span style="color:#cf222e">int</span> P<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">int</span> i <span style="color:#0550ae">=</span> blockIdx<span style="color:#1f2328">.</span>y <span style="color:#0550ae">*</span> blockDim<span style="color:#1f2328">.</span>y <span style="color:#0550ae">+</span> threadIdx<span style="color:#1f2328">.</span>y<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">int</span> k <span style="color:#0550ae">=</span> blockIdx<span style="color:#1f2328">.</span>x <span style="color:#0550ae">*</span> blockDim<span style="color:#1f2328">.</span>x <span style="color:#0550ae">+</span> threadIdx<span style="color:#1f2328">.</span>x<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>i <span style="color:#0550ae">&lt;</span> N <span style="color:#0550ae">&amp;&amp;</span> k <span style="color:#0550ae">&lt;</span> P<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">double</span> sum <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.0f</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#cf222e">for</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">int</span> j <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> j <span style="color:#0550ae">&lt;</span> M<span style="color:#1f2328">;</span> <span style="color:#0550ae">++</span>j<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>            sum <span style="color:#0550ae">+=</span> A<span style="color:#1f2328">[</span>i <span style="color:#0550ae">*</span> M <span style="color:#0550ae">+</span> j<span style="color:#1f2328">]</span> <span style="color:#0550ae">*</span> B<span style="color:#1f2328">[</span>j <span style="color:#0550ae">*</span> P <span style="color:#0550ae">+</span> k<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>        C<span style="color:#1f2328">[</span>i <span style="color:#0550ae">*</span> P <span style="color:#0550ae">+</span> k<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> sum<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">int</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Matrix sizes
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">int</span> N <span style="color:#0550ae">=</span> <span style="color:#0550ae">2000</span><span style="color:#1f2328">,</span> M <span style="color:#0550ae">=</span> <span style="color:#0550ae">3000</span><span style="color:#1f2328">,</span> P <span style="color:#0550ae">=</span> <span style="color:#0550ae">4000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">double</span> <span style="color:#0550ae">*</span>hostA<span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span>hostB<span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span>hostC<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">double</span> <span style="color:#0550ae">*</span>devA<span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span>devB<span style="color:#1f2328">,</span> <span style="color:#0550ae">*</span>devC<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Allocate host memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    hostA <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>N <span style="color:#0550ae">*</span> M <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    hostB <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>M <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    hostC <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>N <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Verify that allocations succeeded
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">if</span> <span style="color:#1f2328">(</span>hostA <span style="color:#0550ae">==</span> <span style="color:#6639ba">NULL</span> <span style="color:#0550ae">||</span> hostB <span style="color:#0550ae">==</span> <span style="color:#6639ba">NULL</span> <span style="color:#0550ae">||</span> hostC <span style="color:#0550ae">==</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>      fprintf<span style="color:#1f2328">(</span>stderr<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;Failed to allocate host vectors!</span><span style="color:#0a3069">\n</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>      exit<span style="color:#1f2328">(</span>EXIT_FAILURE<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Data initialization omitted
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Allocate device memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    checkCudaError<span style="color:#1f2328">(</span>cudaMalloc<span style="color:#1f2328">((</span><span style="color:#cf222e">void</span><span style="color:#0550ae">**</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>devA<span style="color:#1f2328">,</span> N <span style="color:#0550ae">*</span> M <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">)));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaMalloc<span style="color:#1f2328">((</span><span style="color:#cf222e">void</span><span style="color:#0550ae">**</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>devB<span style="color:#1f2328">,</span> M <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">)));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaMalloc<span style="color:#1f2328">((</span><span style="color:#cf222e">void</span><span style="color:#0550ae">**</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>devC<span style="color:#1f2328">,</span> N <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">)));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Copy matrices from host to device
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    checkCudaError<span style="color:#1f2328">(</span>cudaMemcpy<span style="color:#1f2328">(</span>devA<span style="color:#1f2328">,</span> hostA<span style="color:#1f2328">,</span> N <span style="color:#0550ae">*</span> M <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">),</span> cudaMemcpyHostToDevice<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaMemcpy<span style="color:#1f2328">(</span>devB<span style="color:#1f2328">,</span> hostB<span style="color:#1f2328">,</span> M <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">),</span> cudaMemcpyHostToDevice<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Define block and grid sizes
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    dim3 blockDim<span style="color:#1f2328">(</span><span style="color:#0550ae">16</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">16</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    dim3 gridDim<span style="color:#1f2328">((</span>P <span style="color:#0550ae">+</span> blockDim<span style="color:#1f2328">.</span>x <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">/</span> blockDim<span style="color:#1f2328">.</span>x<span style="color:#1f2328">,</span> <span style="color:#1f2328">(</span>N <span style="color:#0550ae">+</span> blockDim<span style="color:#1f2328">.</span>y <span style="color:#0550ae">-</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">)</span> <span style="color:#0550ae">/</span> blockDim<span style="color:#1f2328">.</span>y<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Launch the kernel
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    matrixMultiplyKernel<span style="color:#0550ae">&lt;&lt;&lt;</span>gridDim<span style="color:#1f2328">,</span> blockDim<span style="color:#0550ae">&gt;&gt;&gt;</span><span style="color:#1f2328">(</span>devA<span style="color:#1f2328">,</span> devB<span style="color:#1f2328">,</span> devC<span style="color:#1f2328">,</span> N<span style="color:#1f2328">,</span> M<span style="color:#1f2328">,</span> P<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaPeekAtLastError<span style="color:#1f2328">());</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaDeviceSynchronize<span style="color:#1f2328">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Copy result matrix from device to host
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    checkCudaError<span style="color:#1f2328">(</span>cudaMemcpy<span style="color:#1f2328">(</span>hostC<span style="color:#1f2328">,</span> devC<span style="color:#1f2328">,</span> N <span style="color:#0550ae">*</span> P <span style="color:#0550ae">*</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">double</span><span style="color:#1f2328">),</span> cudaMemcpyDeviceToHost<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Free device memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    checkCudaError<span style="color:#1f2328">(</span>cudaFree<span style="color:#1f2328">(</span>devA<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaFree<span style="color:#1f2328">(</span>devB<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>    checkCudaError<span style="color:#1f2328">(</span>cudaFree<span style="color:#1f2328">(</span>devC<span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Free host memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    free<span style="color:#1f2328">(</span>hostA<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    free<span style="color:#1f2328">(</span>hostB<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>    free<span style="color:#1f2328">(</span>hostC<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">return</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span></span></span></code></pre></div></div>
        
          
          <div class="code-comparison code-sample2" data-for-sample="OpenCL"><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C++" data-lang="C++"><span style="display:flex;"><span><span style="color:#57606a">/* Implementation based on https://cnugteren.github.io/tutorial/pages/page3.html
</span></span></span><span style="display:flex;"><span><span style="color:#57606a">   This kernel appears in a different file from main */</span>
</span></span><span style="display:flex;"><span>__kernel <span style="color:#cf222e">void</span> <span style="color:#6639ba">myGEMM1</span><span style="color:#1f2328">(</span><span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> M<span style="color:#1f2328">,</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> N<span style="color:#1f2328">,</span> <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> P<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#cf222e">const</span> __global <span style="color:#cf222e">float</span><span style="color:#0550ae">*</span> A<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                      <span style="color:#cf222e">const</span> __global <span style="color:#cf222e">float</span><span style="color:#0550ae">*</span> B<span style="color:#1f2328">,</span>
</span></span><span style="display:flex;"><span>                      __global <span style="color:#cf222e">float</span><span style="color:#0550ae">*</span> C<span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Thread identifiers
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> globalRow <span style="color:#0550ae">=</span> get_global_id<span style="color:#1f2328">(</span><span style="color:#0550ae">0</span><span style="color:#1f2328">);</span> <span style="color:#57606a">// Row ID of C (0..M)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> globalCol <span style="color:#0550ae">=</span> get_global_id<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">);</span> <span style="color:#57606a">// Col ID of C (0..N)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Compute a single element (loop over K)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    <span style="color:#cf222e">float</span> acc <span style="color:#0550ae">=</span> <span style="color:#0550ae">0.0f</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">int</span> k<span style="color:#0550ae">=</span><span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> k<span style="color:#0550ae">&lt;</span>P<span style="color:#1f2328">;</span> k<span style="color:#0550ae">++</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>        acc <span style="color:#0550ae">+=</span> A<span style="color:#1f2328">[</span>k<span style="color:#0550ae">*</span>M <span style="color:#0550ae">+</span> globalRow<span style="color:#1f2328">]</span> <span style="color:#0550ae">*</span> B<span style="color:#1f2328">[</span>globalCol<span style="color:#0550ae">*</span>P <span style="color:#0550ae">+</span> k<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a">// Store the result
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>    C<span style="color:#1f2328">[</span>globalCol<span style="color:#0550ae">*</span>M <span style="color:#0550ae">+</span> globalRow<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> acc<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">void</span> <span style="color:#6639ba">main</span><span style="color:#1f2328">()</span> <span style="color:#1f2328">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Define the matrix dimensions
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> M <span style="color:#0550ae">=</span> <span style="color:#0550ae">2000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> N <span style="color:#0550ae">=</span> <span style="color:#0550ae">3000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">const</span> <span style="color:#cf222e">int</span> P <span style="color:#0550ae">=</span> <span style="color:#0550ae">4000</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Define OpenCL variables
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  cl_int err<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_platform_id platform <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_device_id device <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_device_id devices<span style="color:#1f2328">[</span>MAX_NUM_DEVICES<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>  cl_uint numDevices <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_context_properties props<span style="color:#1f2328">[</span><span style="color:#0550ae">3</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span>CL_CONTEXT_PLATFORM<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>  cl_context context <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_command_queue queue <span style="color:#0550ae">=</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_event event <span style="color:#0550ae">=</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_program program <span style="color:#0550ae">=</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span> deviceName<span style="color:#1f2328">[</span>MAX_DEVICE_NAME<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Configure the OpenCL environment
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clGetPlatformIDs<span style="color:#1f2328">(</span><span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>platform<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetDeviceIDs<span style="color:#1f2328">(</span>platform<span style="color:#1f2328">,</span> CL_DEVICE_TYPE_GPU<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>numDevices<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetDeviceIDs<span style="color:#1f2328">(</span>platform<span style="color:#1f2328">,</span> CL_DEVICE_TYPE_GPU<span style="color:#1f2328">,</span> numDevices<span style="color:#1f2328">,</span> devices<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  device <span style="color:#0550ae">=</span> devices<span style="color:#1f2328">[</span>CURRENT_DEVICE<span style="color:#1f2328">];</span>
</span></span><span style="display:flex;"><span>  props<span style="color:#1f2328">[</span><span style="color:#0550ae">1</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span>cl_context_properties<span style="color:#1f2328">)</span>platform<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  context <span style="color:#0550ae">=</span> clCreateContext<span style="color:#1f2328">(</span>props<span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>device<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  queue <span style="color:#0550ae">=</span> clCreateCommandQueue<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> device<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetDeviceInfo<span style="color:#1f2328">(</span>device<span style="color:#1f2328">,</span> CL_DEVICE_NAME<span style="color:#1f2328">,</span> MAX_DEVICE_NAME<span style="color:#1f2328">,</span> deviceName<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Read the kernel file from disk
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  <span style="color:#cf222e">long</span> sizeHeader<span style="color:#1f2328">,</span> sizeSource<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> header <span style="color:#0550ae">=</span> readKernelFile<span style="color:#1f2328">(</span>CL_INCLUDE_FILE<span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>sizeHeader<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> source <span style="color:#0550ae">=</span> readKernelFile<span style="color:#1f2328">(</span>CL_KERNEL_FILE<span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>sizeSource<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">long</span> size <span style="color:#0550ae">=</span> <span style="color:#0550ae">2</span> <span style="color:#0550ae">+</span> sizeHeader <span style="color:#0550ae">+</span> sizeSource<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> code <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>size<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">for</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">int</span> c<span style="color:#0550ae">=</span><span style="color:#0550ae">0</span><span style="color:#1f2328">;</span> c<span style="color:#0550ae">&lt;</span>size<span style="color:#1f2328">;</span> c<span style="color:#0550ae">++</span><span style="color:#1f2328">)</span> <span style="color:#1f2328">{</span> code<span style="color:#1f2328">[</span>c<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;\0&#39;</span><span style="color:#1f2328">;</span> <span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>  strcat<span style="color:#1f2328">(</span>code<span style="color:#1f2328">,</span> header<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  strcat<span style="color:#1f2328">(</span>code<span style="color:#1f2328">,</span> source<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">const</span> <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> constCode <span style="color:#0550ae">=</span> code<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  free<span style="color:#1f2328">(</span>header<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  free<span style="color:#1f2328">(</span>source<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Compile the kernel file
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  program <span style="color:#0550ae">=</span> clCreateProgramWithSource<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>constCode<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clBuildProgram<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> COMPILER_OPTIONS<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Check for compilation errors
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  size_t logSize<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetProgramBuildInfo<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> device<span style="color:#1f2328">,</span> CL_PROGRAM_BUILD_LOG<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>logSize<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">char</span><span style="color:#0550ae">*</span> messages <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">((</span><span style="color:#0550ae">1</span><span style="color:#0550ae">+</span>logSize<span style="color:#1f2328">)</span><span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#1f2328">));</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetProgramBuildInfo<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> device<span style="color:#1f2328">,</span> CL_PROGRAM_BUILD_LOG<span style="color:#1f2328">,</span> logSize<span style="color:#1f2328">,</span> messages<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  messages<span style="color:#1f2328">[</span>logSize<span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#39;\0&#39;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">//if (logSize &gt; 10) { printf(&#34;## Compiler message: %s\n&#34;, messages); }
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  free<span style="color:#1f2328">(</span>messages<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Retrieve the PTX code from the OpenCL compiler and output it to disk
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  size_t binSize<span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetProgramInfo<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> CL_PROGRAM_BINARY_SIZES<span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span>size_t<span style="color:#1f2328">),</span> <span style="color:#0550ae">&amp;</span>binSize<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">unsigned</span> <span style="color:#cf222e">char</span> <span style="color:#0550ae">*</span>bin <span style="color:#0550ae">=</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">unsigned</span> <span style="color:#cf222e">char</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">)</span>malloc<span style="color:#1f2328">(</span>binSize<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clGetProgramInfo<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> CL_PROGRAM_BINARIES<span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">unsigned</span> <span style="color:#cf222e">char</span> <span style="color:#0550ae">*</span><span style="color:#1f2328">),</span> <span style="color:#0550ae">&amp;</span>bin<span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  FILE<span style="color:#0550ae">*</span> file <span style="color:#0550ae">=</span> fopen<span style="color:#1f2328">(</span>CL_PTX_FILE<span style="color:#1f2328">,</span> <span style="color:#0a3069">&#34;wb&#34;</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  fwrite<span style="color:#1f2328">(</span>bin<span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">char</span><span style="color:#1f2328">),</span> binSize<span style="color:#1f2328">,</span> file<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  fclose<span style="color:#1f2328">(</span>file<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  free<span style="color:#1f2328">(</span>bin<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Prepare OpenCL memory objects
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  cl_mem bufA    <span style="color:#0550ae">=</span> clCreateBuffer<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> CL_MEM_READ_ONLY<span style="color:#1f2328">,</span>  M<span style="color:#0550ae">*</span>P<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>A<span style="color:#1f2328">),</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  cl_mem bufB    <span style="color:#0550ae">=</span> clCreateBuffer<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> CL_MEM_READ_ONLY<span style="color:#1f2328">,</span>  P<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>B<span style="color:#1f2328">),</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  cl_mem bufB_TR <span style="color:#0550ae">=</span> clCreateBuffer<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> CL_MEM_READ_ONLY<span style="color:#1f2328">,</span>  N<span style="color:#0550ae">*</span>P<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>B<span style="color:#1f2328">),</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  cl_mem bufC    <span style="color:#0550ae">=</span> clCreateBuffer<span style="color:#1f2328">(</span>context<span style="color:#1f2328">,</span> CL_MEM_READ_WRITE<span style="color:#1f2328">,</span> M<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>C<span style="color:#1f2328">),</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Copy matrices to the GPU (also C to erase the results of the previous run)
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clEnqueueWriteBuffer<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> bufA<span style="color:#1f2328">,</span> CL_TRUE<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> M<span style="color:#0550ae">*</span>P<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>A<span style="color:#1f2328">),</span> A<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clEnqueueWriteBuffer<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> bufB<span style="color:#1f2328">,</span> CL_TRUE<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> P<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>B<span style="color:#1f2328">),</span> B<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clEnqueueWriteBuffer<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> bufC<span style="color:#1f2328">,</span> CL_TRUE<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> M<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>C<span style="color:#1f2328">),</span> C<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Configure the myGEMM kernel
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  <span style="color:#cf222e">char</span> kernelname<span style="color:#1f2328">[</span><span style="color:#0550ae">100</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#0a3069">&#34;myGEMM1&#34;</span><span style="color:#1f2328">;</span>
</span></span><span style="display:flex;"><span>  cl_kernel kernel1 <span style="color:#0550ae">=</span> clCreateKernel<span style="color:#1f2328">(</span>program<span style="color:#1f2328">,</span> kernelname<span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>err<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Set the kernel arguments
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>M<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">1</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>N<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#cf222e">int</span><span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>P<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">3</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span>cl_mem<span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>bufA<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">4</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span>cl_mem<span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>bufB<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  err <span style="color:#0550ae">=</span> clSetKernelArg<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">5</span><span style="color:#1f2328">,</span> <span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span>cl_mem<span style="color:#1f2328">),</span> <span style="color:#1f2328">(</span><span style="color:#cf222e">void</span><span style="color:#0550ae">*</span><span style="color:#1f2328">)</span><span style="color:#0550ae">&amp;</span>bufC<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Configure the thread/work-group dimensions of the myGEMM kernel
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  <span style="color:#cf222e">const</span> size_t local<span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span> TS<span style="color:#1f2328">,</span> TS <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>  <span style="color:#cf222e">const</span> size_t global<span style="color:#1f2328">[</span><span style="color:#0550ae">2</span><span style="color:#1f2328">]</span> <span style="color:#0550ae">=</span> <span style="color:#1f2328">{</span> <span style="color:#1f2328">(</span>size_t<span style="color:#1f2328">)</span>M<span style="color:#1f2328">,</span> <span style="color:#1f2328">(</span>size_t<span style="color:#1f2328">)</span>N <span style="color:#1f2328">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Run the myGEMM kernel
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clEnqueueNDRangeKernel<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> kernel1<span style="color:#1f2328">,</span> <span style="color:#0550ae">2</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> global<span style="color:#1f2328">,</span> local<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#0550ae">&amp;</span>event<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Copy the output matrix C back to the CPU memory
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  err <span style="color:#0550ae">=</span> clEnqueueReadBuffer<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">,</span> bufC<span style="color:#1f2328">,</span> CL_TRUE<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> M<span style="color:#0550ae">*</span>N<span style="color:#0550ae">*</span><span style="color:#cf222e">sizeof</span><span style="color:#1f2328">(</span><span style="color:#0550ae">*</span>C<span style="color:#1f2328">),</span> C<span style="color:#1f2328">,</span> <span style="color:#0550ae">0</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">,</span> <span style="color:#6639ba">NULL</span><span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  checkError<span style="color:#1f2328">(</span>err<span style="color:#1f2328">,</span>__LINE__<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Free the memory objects
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  free<span style="color:#1f2328">(</span>code<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufA<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufB<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufB_TR<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufC<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufA_XL<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufB_TR_XL<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseMemObject<span style="color:#1f2328">(</span>bufC_XL<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#57606a">// Clean-up OpenCL 
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>  clReleaseCommandQueue<span style="color:#1f2328">(</span>queue<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseContext<span style="color:#1f2328">(</span>context<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseProgram<span style="color:#1f2328">(</span>program<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span>  clReleaseKernel<span style="color:#1f2328">(</span>kernel1<span style="color:#1f2328">);</span>
</span></span><span style="display:flex;"><span><span style="color:#1f2328">}</span>
</span></span><span style="display:flex;"><span>
</span></span></code></pre></div></div>
        
      </div>
    </div>
  </div>
  <script>
    function setupCodeSample(num) {
      const elt = document.getElementById("code-comparison" + num);
      const inputs = elt.querySelectorAll("input[type=radio]");
      for (const input of inputs) {
        console.log(input);
      }
      const selected = elt.querySelector("input[type=radio]:checked");
      console.log("Selected:");
      console.log(selected);
      const samples = elt.querySelectorAll(".code-sample" + num + "[data-for-sample]");
      console.log("Samples:");
      for (const s of samples) {
        console.log(s);
      }
      function showInput(input) {
        for (const s of samples) {
          if (s.attributes["data-for-sample"].value === input.value) {
            s.style.display = "block";
            console.log("Setting to block");
          } else {
            s.style.display = "none";
            console.log("setting to none");
          }
        }
      }

      showInput(selected);
      for (const input of inputs) {
        input.addEventListener("change", () => showInput(input));
      }
    }
    setupCodeSample("1");
    setupCodeSample("2");
  </script>
  

</section>

<h1 id="key-features-of-chapel-for-gpu-execution">Key Features of Chapel for GPU Execution</h1>


<section class="background-white">
  <div class="container">
      
      
      

      <div class="row">
        
            <div class="attribute-item col-md-4 col-sm-6 col-xs-12">
                
                    <a href="../blog/posts/intro-to-gpus/">
                

                <div class="box-simple background-white">
                    <h3>Unified Syntax</h3>
                    <p>No need to write seperate code for GPUs and CPUs.</p>
                </div>

                
                    </a>
                  
            </div>
        
            <div class="attribute-item col-md-4 col-sm-6 col-xs-12">
                
                    <a href="../blog/posts/gpu-data-movement/">
                

                <div class="box-simple background-white">
                    <h3>Multi-Level Abstractions</h3>
                    <p>Mix high- and low-level control over execution, distribution, and data transfer.</p>
                </div>

                
                    </a>
                  
            </div>
        
            <div class="attribute-item col-md-4 col-sm-6 col-xs-12">
                
                    <a href="https://chapel-lang.org/docs/technotes/gpu.html#vendor-portability">
                

                <div class="box-simple background-white">
                    <h3>Vendor-Neutral</h3>
                    <p>Run the same code on NVIDIA and AMD GPUs.</p>
                </div>

                
                    </a>
                  
            </div>
        
      </div>
  </div>
</section>

                        </div>

                    </div>

                </div>
                

                <hr class="half-rule invisible">
                <hr class="half-rule invisible">

            </div>
            

            
        </div>
        

        <footer id="footer">
  <div class="container">

    
    <div class="col-md-3 col-sm-3 footer-icon-list">
      <h4> Follow Us </h4>
      
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://bsky.app/profile/chapellanguage.bsky.social">
          <img src="../img/socials/bluesky.png" alt="BlueSky" /> BlueSky
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://www.facebook.com/ChapelLanguage">
          <img src="../img/socials/facebook.png" alt="Facebook" /> Facebook
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://www.linkedin.com/company/chapellanguage">
          <img src="../img/socials/linkedin.png" alt="LinkedIn" /> LinkedIn
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://mastodon.social/@chapelprogramminglanguage">
          <img src="../img/socials/mastodon.png" alt="Mastodon" /> Mastodon
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://www.reddit.com/r/chapel/">
          <img src="../img/socials/reddit.png" alt="Reddit" /> Reddit
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://x.com/ChapelLanguage">
          <img src="../img/socials/twitter.png" alt="X (Twitter)" /> X (Twitter)
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://www.youtube.com/@ChapelLanguage">
          <img src="../img/socials/youtube.png" alt="YouTube" /> YouTube
        </a>
      </div>
      
    </div>

    <div class="col-md-3 col-sm-3 footer-icon-list">
      <h4> Get In Touch </h4>
      
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://discord.gg/xu2xg45yqH">
          <img src="../img/socials/discord.png" alt="Discord" /> Discord
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://chapel.discourse.group/">
          <img src="../img/socials/discourse.png" alt="Discourse" /> Discourse
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="mailto:chapel&#43;qs@discoursemail.com">
          <img src="../img/socials/mail.png" alt="Email" /> Email
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://github.com/chapel-lang/chapel/issues/new/choose">
          <img src="../img/socials/github.png" alt="GitHub Issues" /> GitHub Issues
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://gitter.im/chapel-lang/chapel">
          <img src="../img/socials/gitter.png" alt="Gitter" /> Gitter
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://stackoverflow.com/questions/tagged/chapel">
          <img src="../img/socials/stackOverflow.png" alt="Stack Overflow" /> Stack Overflow
        </a>
      </div>
      
    </div>

    <div class="col-md-3 col-sm-3 footer-icon-list">
      <h4> Get Started </h4>
      
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://ato.pxeger.com/run?1=m70sOSOxIDVnwYKlpSVpuhY7y4syS1Jz8jSUPFJzcvJ1FMrzi3JSFJU0rSHyUGUw5QA">
          <img src="../img/socials/ato.png" alt="Attempt This Online" /> Attempt This Online
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://hub.docker.com/r/chapel/chapel">
          <img src="../img/socials/docker.png" alt="Docker" /> Docker
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://e4s-project.github.io/DocPortal.html">
          <img src="../img/socials/e4s.png" alt="E4S" /> E4S
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://github.com/chapel-lang/chapel/releases">
          <img src="../img/socials/github.png" alt="GitHub Releases" /> GitHub Releases
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://formulae.brew.sh/formula/chapel">
          <img src="../img/socials/homebrew.png" alt="Homebrew" /> Homebrew
        </a>
      </div>
      

      <div class="col-md-12 col-sm-12 footer-icon-entry">
        <a href="https://packages.spack.io/package.html?name=chapel">
          <img src="../img/socials/spack.png" alt="Spack" /> Spack
        </a>
      </div>
      
    </div>

  </div>
</footer>


    </div>
    

    
<script src="../js/jquery.js"></script>
<script src="../js/bootstrap.js"></script>


<script src="../js/waypoints.js"></script>
<script src="../js/Counter-Up.js"></script>


<script src="../js/front.js"></script>

<script src="../js/owl.carousel.min.js"></script>



  </body>
</html>
